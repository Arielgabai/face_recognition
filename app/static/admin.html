<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Face Recognition App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        button.success {
            background-color: #28a745;
        }
        button.success:hover {
            background-color: #218838;
        }
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
            white-space: nowrap;
        }
        .tab.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .card h3 {
            margin-top: 0;
            color: #333;
        }
        .qr-code {
            text-align: center;
            margin: 20px 0;
        }
        .qr-code img {
            max-width: 200px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .card-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .card-actions button {
            flex: 1;
            min-width: 80px;
            font-size: 14px;
            padding: 8px 12px;
        }
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .card-actions {
                flex-direction: column;
            }
        }
        
        /* Styles pour l'optimisation des photos */
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .profile-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .profile-card h5 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .profile-card p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #6c757d;
        }
        #estimationResult {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 5px;
            padding: 15px;
        }
        #cleanupResult {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üëë Administration - Face Recognition App</h1>
        
        <div id="loginForm">
            <h2>Connexion Admin</h2>
            <div class="form-group">
                <label for="username">Nom d'utilisateur:</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">Mot de passe:</label>
                <input type="password" id="password" required>
            </div>
            <button onclick="login()">Se connecter</button>
        </div>

        <div id="dashboard" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Tableau de bord Admin</h2>
                <button onclick="logout()" class="danger">D√©connexion</button>
            </div>
            
            <div class="stats" id="stats">
                <!-- Les statistiques seront charg√©es ici -->
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('photographers')">üì∏ Photographes</button>
                <button class="tab" onclick="showTab('events')">üéâ √âv√©nements</button>
                <button class="tab" onclick="showTab('qr-codes')">üì± QR Codes</button>
                <button class="tab" onclick="showTab('optimization')">üóúÔ∏è Optimisation Photos</button>
                <button class="tab" onclick="showTab('create-admin')">üë§ Cr√©er Admin</button>
            </div>

            <div id="photographers" class="tab-content active">
                <h3>Gestion des Photographes</h3>
                <div class="card">
                    <h4>Cr√©er un nouveau photographe</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="photographerUsername">Nom d'utilisateur:</label>
                            <input type="text" id="photographerUsername" placeholder="ex: photographe1" required>
                        </div>
                        <div class="form-group">
                            <label for="photographerEmail">Email:</label>
                            <input type="email" id="photographerEmail" placeholder="ex: photographe@example.com" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="photographerPassword">Mot de passe:</label>
                        <input type="password" id="photographerPassword" placeholder="Mot de passe s√©curis√©" required>
                    </div>
                    <button onclick="createPhotographer()" class="success">Cr√©er le photographe</button>
                </div>
                
                <div class="card">
                    <h4>Liste des photographes</h4>
                    <div id="photographersList">Chargement...</div>
                </div>
            </div>

            <div id="events" class="tab-content">
                <h3>Gestion des √âv√©nements</h3>
                <div class="card">
                    <h4>Cr√©er un nouvel √©v√©nement</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventName">Nom de l'√©v√©nement:</label>
                            <input type="text" id="eventName" placeholder="ex: Mariage de Marie et Paul" required>
                        </div>
                        <div class="form-group">
                            <label for="eventCode">Code √©v√©nement:</label>
                            <input type="text" id="eventCode" placeholder="ex: MARIAGE2024" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventDate">Date:</label>
                            <input type="date" id="eventDate">
                        </div>
                        <div class="form-group">
                            <label for="eventPhotographer">Photographe assign√©:</label>
                            <select id="eventPhotographer" required>
                                <option value="">S√©lectionner un photographe</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="createNewEvent()" class="success">Cr√©er l'√©v√©nement</button>
                </div>
                
                <div class="card">
                    <h4>Liste des √©v√©nements</h4>
                    <div id="eventsList">Chargement...</div>
                </div>
            </div>

            <div id="qr-codes" class="tab-content">
                <h3>G√©n√©ration de QR Codes</h3>
                <div class="card">
                    <h4>G√©n√©rer un QR Code pour un √©v√©nement</h4>
                    <div class="form-group">
                        <label for="qrEventCode">Code √©v√©nement:</label>
                        <select id="qrEventCode" required>
                            <option value="">S√©lectionner un √©v√©nement</option>
                        </select>
                    </div>
                    <button onclick="generateQRCode()" class="success">G√©n√©rer le QR Code</button>
                    <div id="qrCodeResult"></div>
                </div>
            </div>

            <div id="optimization" class="tab-content">
                <h3>üóúÔ∏è Optimisation des Photos</h3>
                
                <!-- Statistiques d'optimisation -->
                <div class="card">
                    <h4>üìä Statistiques d'Optimisation</h4>
                    <div id="optimizationStats">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div class="stat-card">
                                <div class="stat-number" id="totalPhotos">-</div>
                                <div class="stat-label">Photos trait√©es</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalSpaceSaved">-</div>
                                <div class="stat-label">Espace √©conomis√© (MB)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="avgCompression">-</div>
                                <div class="stat-label">Compression moyenne (%)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="expiredPhotos">-</div>
                                <div class="stat-label">Photos expir√©es</div>
                            </div>
                        </div>
                        <button onclick="loadOptimizationStats()" class="success">üîÑ Actualiser</button>
                        <button onclick="runMigration()" class="warning" style="margin-left: 10px;">‚öôÔ∏è Migration BDD</button>
                    </div>
                </div>

                <!-- Estimateur de compression -->
                <div class="card">
                    <h4>üßÆ Estimateur de Compression</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fileSize">Taille du fichier (MB):</label>
                            <input type="number" id="fileSize" step="0.1" min="0.1" placeholder="ex: 5.2">
                        </div>
                        <div class="form-group">
                            <label for="qualityProfile">Profil de qualit√©:</label>
                            <select id="qualityProfile">
                                <option value="low">üî¥ Low (60% qualit√©)</option>
                                <option value="medium">üü° Medium (75% qualit√©)</option>
                                <option value="high" selected>üü¢ High (85% qualit√©)</option>
                                <option value="ultra">üîµ Ultra (95% qualit√©)</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="estimateCompression()">üìè Estimer</button>
                    <div id="estimationResult" style="margin-top: 15px;"></div>
                </div>

                <!-- Gestion des profils -->
                <div class="card">
                    <h4>‚öôÔ∏è Profils de Qualit√©</h4>
                    <div id="qualityProfiles">
                        <div class="profiles-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div class="profile-card">
                                <h5>üî¥ Low Quality</h5>
                                <p>Qualit√©: 60% ‚Ä¢ Max: 1280x720</p>
                                <p>Id√©al pour: Aper√ßus, miniatures</p>
                            </div>
                            <div class="profile-card">
                                <h5>üü° Medium Quality</h5>
                                <p>Qualit√©: 75% ‚Ä¢ Max: 1600x900</p>
                                <p>Id√©al pour: Web, partage social</p>
                            </div>
                            <div class="profile-card">
                                <h5>üü¢ High Quality</h5>
                                <p>Qualit√©: 85% ‚Ä¢ Max: 1920x1080</p>
                                <p>Id√©al pour: Production standard</p>
                            </div>
                            <div class="profile-card">
                                <h5>üîµ Ultra Quality</h5>
                                <p>Qualit√©: 95% ‚Ä¢ Max: 2560x1440</p>
                                <p>Id√©al pour: Archivage, impression</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nettoyage des photos expir√©es -->
                <div class="card">
                    <h4>üóëÔ∏è Nettoyage des Photos</h4>
                    <p style="color: #666;">
                        Supprime automatiquement les photos dont la dur√©e de r√©tention a expir√©.
                    </p>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffc107;">
                        <strong>‚ö†Ô∏è Attention:</strong> Cette action est irr√©versible. Les photos supprim√©es ne peuvent pas √™tre r√©cup√©r√©es.
                    </div>
                    <button onclick="cleanupExpiredPhotos()" class="danger">üóëÔ∏è Nettoyer les photos expir√©es</button>
                    <div id="cleanupResult" style="margin-top: 15px;"></div>
                </div>
            </div>

            <div id="create-admin" class="tab-content">
                <h3>Cr√©er un compte Admin</h3>
                <div class="card">
                    <h4>Nouveau compte administrateur</h4>
                    <p style="color: #666; margin-bottom: 20px;">
                        ‚ö†Ô∏è Cette fonctionnalit√© ne peut √™tre utilis√©e qu'une seule fois, 
                        uniquement si aucun admin n'existe encore dans le syst√®me.
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="adminUsername">Nom d'utilisateur:</label>
                            <input type="text" id="adminUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="adminEmail">Email:</label>
                            <input type="email" id="adminEmail" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="adminPassword">Mot de passe:</label>
                        <input type="password" id="adminPassword" required>
                    </div>
                    <button onclick="createAdmin()" class="success">Cr√©er l'admin</button>
                </div>
            </div>
        </div>

        <div id="alert"></div>
    </div>

    <script>
        let currentUser = null;
        let token = localStorage.getItem('token');

        if (token) {
            loadDashboard();
        }

        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('alert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('token', data.access_token);
                    token = data.access_token;
                    loadDashboard();
                } else {
                    showAlert(data.detail || 'Erreur de connexion', 'error');
                }
            } catch (error) {
                showAlert('Erreur de connexion', 'error');
            }
        }

        async function loadDashboard() {
            try {
                const response = await fetch('/api/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });

                if (response.ok) {
                    currentUser = await response.json();
                    
                    if (currentUser.user_type !== 'admin') {
                        showAlert('Acc√®s refus√©. Seuls les admins peuvent acc√©der √† cette interface.', 'error');
                        logout();
                        return;
                    }

                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    
                    loadStats();
                    loadPhotographers();
                    loadEvents();
                } else {
                    localStorage.removeItem('token');
                    token = null;
                }
            } catch (error) {
                console.error('Erreur lors du chargement du dashboard:', error);
            }
        }

        async function loadStats() {
            try {
                const [photographersResponse, eventsResponse] = await Promise.all([
                    fetch('/api/admin/photographers', {
                        headers: { 'Authorization': `Bearer ${token}` },
                    }),
                    fetch('/api/admin/events', {
                        headers: { 'Authorization': `Bearer ${token}` },
                    })
                ]);

                const photographers = photographersResponse.ok ? await photographersResponse.json() : [];
                const events = eventsResponse.ok ? await eventsResponse.json() : [];

                document.getElementById('stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${photographers.length}</div>
                        <div class="stat-label">Photographes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${events.length}</div>
                        <div class="stat-label">√âv√©nements</div>
                    </div>
                `;
            } catch (error) {
                console.error('Erreur lors du chargement des stats:', error);
            }
        }

        async function loadPhotographers() {
            try {
                const response = await fetch('/api/admin/photographers', {
                    headers: { 'Authorization': `Bearer ${token}` },
                });

                if (response.ok) {
                    const photographers = await response.json();
                    displayPhotographers(photographers);
                    updatePhotographerSelects(photographers);
                } else {
                    document.getElementById('photographersList').innerHTML = 'Erreur lors du chargement des photographes.';
                }
            } catch (error) {
                console.error('Erreur lors du chargement des photographes:', error);
            }
        }

        function displayPhotographers(photographers) {
            const container = document.getElementById('photographersList');
            
            if (!photographers || photographers.length === 0) {
                container.innerHTML = 'Aucun photographe trouv√©.';
                return;
            }

            container.innerHTML = `
                <div class="grid">
                    ${photographers.map(photographer => `
                        <div class="card">
                            <h4>${photographer.username}</h4>
                            <p><strong>Email:</strong> ${photographer.email}</p>
                            <p><strong>ID:</strong> ${photographer.id}</p>
                            <div class="card-actions">
                                <button onclick="editPhotographer(${photographer.id}, '${photographer.username}', '${photographer.email}')" class="success">Modifier</button>
                                <button onclick="deletePhotographer(${photographer.id}, '${photographer.username}')" class="danger">Supprimer</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updatePhotographerSelects(photographers) {
            const eventPhotographerSelect = document.getElementById('eventPhotographer');
            eventPhotographerSelect.innerHTML = '<option value="">S√©lectionner un photographe</option>';
            
            photographers.forEach(photographer => {
                const option = document.createElement('option');
                option.value = photographer.id;
                option.textContent = `${photographer.username} (${photographer.email})`;
                eventPhotographerSelect.appendChild(option);
            });
        }

        async function loadEvents() {
            try {
                const response = await fetch('/api/admin/events', {
                    headers: { 'Authorization': `Bearer ${token}` },
                });

                if (response.ok) {
                    const events = await response.json();
                    displayEvents(events);
                    updateEventSelects(events);
                } else {
                    document.getElementById('eventsList').innerHTML = 'Erreur lors du chargement des √©v√©nements.';
                }
            } catch (error) {
                console.error('Erreur lors du chargement des √©v√©nements:', error);
            }
        }

        function displayEvents(events) {
            const container = document.getElementById('eventsList');
            
            if (!events || events.length === 0) {
                container.innerHTML = 'Aucun √©v√©nement trouv√©.';
                return;
            }

            container.innerHTML = `
                <div class="grid">
                    ${events.map(event => `
                        <div class="card">
                            <h4>${event.name}</h4>
                            <p><strong>Code:</strong> ${event.event_code}</p>
                            <p><strong>Date:</strong> ${event.date ? new Date(event.date).toLocaleDateString() : 'Non d√©finie'}</p>
                            <p><strong>Photographe ID:</strong> ${event.photographer_id}</p>
                            <div class="card-actions">
                                <button onclick="editEvent(${event.id}, '${event.name}', '${event.event_code}', '${event.date || ''}', ${event.photographer_id})" class="success">Modifier</button>
                                <button onclick="deleteEvent(${event.id}, '${event.name}')" class="danger">Supprimer</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateEventSelects(events) {
            const qrEventSelect = document.getElementById('qrEventCode');
            qrEventSelect.innerHTML = '<option value="">S√©lectionner un √©v√©nement</option>';
            
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.event_code;
                option.textContent = `${event.name} (${event.event_code})`;
                qrEventSelect.appendChild(option);
            });
        }

        async function createNewEvent() {
            console.log('createNewEvent() appel√©e');
            const name = document.getElementById('eventName').value;
            const eventCode = document.getElementById('eventCode').value;
            const date = document.getElementById('eventDate').value;
            const photographerId = document.getElementById('eventPhotographer').value;

            console.log('Valeurs:', { name, eventCode, date, photographerId, token });

            if (!name || !eventCode || !photographerId) {
                showAlert('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }

            try {
                console.log('Envoi de la requ√™te...');
                const response = await fetch('/api/admin/create-event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ 
                        name, 
                        event_code: eventCode, 
                        date: date || null, 
                        photographer_id: parseInt(photographerId) 
                    }),
                });

                console.log('R√©ponse re√ßue:', response.status);
                const data = await response.json();
                console.log('Donn√©es re√ßues:', data);

                if (response.ok) {
                    showAlert('√âv√©nement cr√©√© avec succ√®s !', 'success');
                    // Vider les champs
                    document.getElementById('eventName').value = '';
                    document.getElementById('eventCode').value = '';
                    document.getElementById('eventDate').value = '';
                    document.getElementById('eventPhotographer').value = '';
                    // Recharger les listes
                    loadEvents();
                    loadStats();
                } else {
                    showAlert(data.detail || 'Erreur lors de la cr√©ation', 'error');
                }
            } catch (error) {
                console.error('Erreur dans createNewEvent:', error);
                showAlert('Erreur lors de la cr√©ation', 'error');
            }
        }

        async function generateQRCode() {
            const eventCode = document.getElementById('qrEventCode').value;

            if (!eventCode) {
                showAlert('Veuillez s√©lectionner un √©v√©nement', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/admin/event-qr/${eventCode}`, {
                    headers: { 'Authorization': `Bearer ${token}` },
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const imageUrl = URL.createObjectURL(blob);
                    
                    document.getElementById('qrCodeResult').innerHTML = `
                        <div class="qr-code">
                            <h4>QR Code pour l'√©v√©nement ${eventCode}</h4>
                            <img src="${imageUrl}" alt="QR Code">
                            <p style="margin-top: 10px; color: #666;">
                                Les invit√©s peuvent scanner ce QR code pour s'inscrire √† l'√©v√©nement.
                            </p>
                        </div>
                    `;
                } else {
                    showAlert('Erreur lors de la g√©n√©ration du QR code', 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la g√©n√©ration du QR code', 'error');
            }
        }

        async function createAdmin() {
            const username = document.getElementById('adminUsername').value;
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            if (!username || !email || !password) {
                showAlert('Veuillez remplir tous les champs', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/register-admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, email, password }),
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Admin cr√©√© avec succ√®s !', 'success');
                    // Vider les champs
                    document.getElementById('adminUsername').value = '';
                    document.getElementById('adminEmail').value = '';
                    document.getElementById('adminPassword').value = '';
                } else {
                    showAlert(data.detail || 'Erreur lors de la cr√©ation', 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la cr√©ation', 'error');
            }
        }

        // === FONCTIONS POUR LA GESTION DES PHOTOGRAPHES ===

        async function createPhotographer() {
            const username = document.getElementById('photographerUsername').value;
            const email = document.getElementById('photographerEmail').value;
            const password = document.getElementById('photographerPassword').value;

            if (!username || !email || !password) {
                showAlert('Veuillez remplir tous les champs', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/photographers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ username, email, password }),
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Photographe cr√©√© avec succ√®s !', 'success');
                    // Vider les champs
                    document.getElementById('photographerUsername').value = '';
                    document.getElementById('photographerEmail').value = '';
                    document.getElementById('photographerPassword').value = '';
                    loadPhotographers(); // Recharger la liste des photographes
                    loadStats(); // Mettre √† jour les statistiques
                } else {
                    showAlert(data.detail || 'Erreur lors de la cr√©ation', 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la cr√©ation', 'error');
            }
        }

        async function deletePhotographer(photographerId, photographerName) {
            console.log('deletePhotographer() appel√©e:', photographerId, photographerName);
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le photographe "${photographerName}" ?`)) {
                return;
            }

            try {
                console.log('Envoi de la requ√™te DELETE...');
                const response = await fetch(`/api/admin/photographers/${photographerId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` },
                });

                console.log('R√©ponse DELETE re√ßue:', response.status);
                const data = await response.json();
                console.log('Donn√©es DELETE re√ßues:', data);

                if (response.ok) {
                    showAlert('Photographe supprim√© avec succ√®s !', 'success');
                    loadPhotographers();
                    loadStats();
                } else {
                    showAlert(data.detail || 'Erreur lors de la suppression', 'error');
                }
            } catch (error) {
                console.error('Erreur dans deletePhotographer:', error);
                showAlert('Erreur lors de la suppression', 'error');
            }
        }

        async function editPhotographer(photographerId, currentUsername, currentEmail) {
            const newUsername = prompt('Nouveau nom d\'utilisateur:', currentUsername);
            if (!newUsername) return;

            const newEmail = prompt('Nouvel email:', currentEmail);
            if (!newEmail) return;

            try {
                const response = await fetch(`/api/admin/photographers/${photographerId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ username: newUsername, email: newEmail }),
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Photographe modifi√© avec succ√®s !', 'success');
                    loadPhotographers();
                } else {
                    showAlert(data.detail || 'Erreur lors de la modification', 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la modification', 'error');
            }
        }

        // === FONCTIONS POUR LA GESTION DES √âV√âNEMENTS ===

        async function deleteEvent(eventId, eventName) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'√©v√©nement "${eventName}" ?\n\n‚ö†Ô∏è ATTENTION: Cette action supprimera √©galement toutes les photos associ√©es √† cet √©v√©nement !`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/events/${eventId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` },
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('√âv√©nement supprim√© avec succ√®s !', 'success');
                    loadEvents();
                    loadStats();
                } else {
                    showAlert(data.detail || 'Erreur lors de la suppression', 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la suppression', 'error');
            }
        }

        async function editEvent(eventId, currentName, currentEventCode, currentDate, currentPhotographerId) {
            const newName = prompt('Nouveau nom de l\'√©v√©nement:', currentName);
            if (!newName) return;

            const newEventCode = prompt('Nouveau code √©v√©nement:', currentEventCode);
            if (!newEventCode) return;

            const newDate = prompt('Nouvelle date (YYYY-MM-DD, laissez vide si pas de date):', currentDate);
            
            // Charger les photographes pour la s√©lection
            try {
                const photographersResponse = await fetch('/api/admin/photographers', {
                    headers: { 'Authorization': `Bearer ${token}` },
                });
                
                if (!photographersResponse.ok) {
                    showAlert('Erreur lors du chargement des photographes', 'error');
                    return;
                }
                
                const photographers = await photographersResponse.json();
                const photographerOptions = photographers.map(p => `${p.id}: ${p.username}`).join('\n');
                const newPhotographerId = prompt(`Nouveau photographe (ID actuel: ${currentPhotographerId}):\n\nPhotographes disponibles:\n${photographerOptions}`, currentPhotographerId);
                
                if (!newPhotographerId) return;

                const response = await fetch(`/api/admin/events/${eventId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ 
                        name: newName, 
                        event_code: newEventCode, 
                        date: newDate || null, 
                        photographer_id: parseInt(newPhotographerId) 
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('√âv√©nement modifi√© avec succ√®s !', 'success');
                    loadEvents();
                } else {
                    showAlert(data.detail || 'Erreur lors de la modification', 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la modification', 'error');
            }
        }

        function showTab(tabName) {
            // Masquer tous les contenus d'onglets
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // D√©sactiver tous les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Afficher le contenu de l'onglet s√©lectionn√©
            document.getElementById(tabName).classList.add('active');
            
            // Activer l'onglet s√©lectionn√©
            event.target.classList.add('active');
        }

        function logout() {
            // Nettoyer compl√®tement le localStorage
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('currentUser');
            
            // R√©initialiser les variables
            token = null;
            currentUser = null;
            
            // Nettoyer les formulaires
            document.getElementById('loginForm').reset();
            
            // Masquer le dashboard et afficher le formulaire de connexion
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            
            // Nettoyer l'affichage
            document.getElementById('stats').innerHTML = '';
            document.getElementById('photographersList').innerHTML = '';
            document.getElementById('eventsList').innerHTML = '';
            
            // Rediriger vers la page d'accueil pour √©viter les probl√®mes de cache
            window.location.href = '/';
            
            console.log('D√©connexion effectu√©e - session nettoy√©e');
        }

        // === FONCTIONS D'OPTIMISATION DES PHOTOS ===

        async function loadOptimizationStats() {
            try {
                const response = await fetch('/api/admin/photo-optimization/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    
                    document.getElementById('totalPhotos').textContent = stats.total_photos;
                    document.getElementById('totalSpaceSaved').textContent = stats.total_space_saved_mb + ' MB';
                    document.getElementById('avgCompression').textContent = stats.average_compression_ratio + '%';
                    document.getElementById('expiredPhotos').textContent = stats.expired_photos_count;
                    
                    showAlert('‚úÖ Statistiques mises √† jour', 'success');
                } else {
                    showAlert('‚ùå Erreur lors du chargement des statistiques', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('‚ùå Erreur de connexion', 'error');
            }
        }

        async function estimateCompression() {
            const fileSize = document.getElementById('fileSize').value;
            const qualityProfile = document.getElementById('qualityProfile').value;
            
            if (!fileSize || fileSize <= 0) {
                showAlert('‚ùå Veuillez entrer une taille de fichier valide', 'error');
                return;
            }

            try {
                const fileSizeBytes = parseFloat(fileSize) * 1024 * 1024; // Convertir MB en bytes
                const response = await fetch(`/api/admin/photo-optimization/estimate?file_size=${fileSizeBytes}&quality_profile=${qualityProfile}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const estimation = await response.json();
                    
                    document.getElementById('estimationResult').innerHTML = `
                        <h5>üìä R√©sultats de l'estimation:</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                            <div><strong>Taille originale:</strong><br/>${estimation.original_size_mb} MB</div>
                            <div><strong>Taille compress√©e:</strong><br/>${estimation.estimated_compressed_size_mb} MB</div>
                            <div><strong>Espace √©conomis√©:</strong><br/>${estimation.estimated_space_saved_mb} MB</div>
                            <div><strong>Compression:</strong><br/>${estimation.estimated_compression_ratio}%</div>
                        </div>
                        <p style="margin-top: 10px; color: #666;">
                            <em>Profil utilis√©: ${estimation.quality_profile}</em>
                        </p>
                    `;
                } else {
                    showAlert('‚ùå Erreur lors de l\'estimation', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('‚ùå Erreur de connexion', 'error');
            }
        }

        async function cleanupExpiredPhotos() {
            if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer toutes les photos expir√©es ? Cette action est irr√©versible.')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/photo-optimization/cleanup-expired', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    document.getElementById('cleanupResult').innerHTML = `
                        <h5>‚úÖ ${result.message}</h5>
                        <p><strong>Photos supprim√©es:</strong> ${result.deleted_count}</p>
                        <p><strong>Espace lib√©r√©:</strong> ${result.space_freed_mb} MB</p>
                    `;
                    
                    showAlert('‚úÖ Nettoyage termin√© avec succ√®s', 'success');
                    
                    // Recharger les statistiques
                    loadOptimizationStats();
                } else {
                    const error = await response.json();
                    showAlert(`‚ùå ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('‚ùå Erreur de connexion', 'error');
            }
        }

        async function runMigration() {
            if (!confirm('‚öôÔ∏è √ätes-vous s√ªr de vouloir ex√©cuter la migration de la base de donn√©es ? Cette op√©ration va ajouter les colonnes d\'optimisation manquantes.')) {
                return;
            }

            try {
                showAlert('üîÑ Migration en cours...', 'info');
                
                const response = await fetch('/api/admin/migrate-photo-optimization', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    let logDisplay = result.log.map(line => `<p>‚Ä¢ ${line}</p>`).join('');
                    
                    document.getElementById('cleanupResult').innerHTML = `
                        <h5>‚úÖ ${result.message}</h5>
                        <p><strong>Photos mises √† jour:</strong> ${result.photos_updated}</p>
                        <p><strong>Total photos avec m√©tadonn√©es:</strong> ${result.total_photos_with_metadata}</p>
                        <div style="margin-top: 15px; max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <h6>üìã Journal de la migration:</h6>
                            ${logDisplay}
                        </div>
                    `;
                    
                    showAlert('‚úÖ Migration termin√©e avec succ√®s ! Vous pouvez maintenant utiliser les fonctionnalit√©s d\'optimisation.', 'success');
                    
                    // Recharger les statistiques
                    setTimeout(() => {
                        loadOptimizationStats();
                    }, 2000);
                } else {
                    const error = await response.json();
                    showAlert(`‚ùå Erreur de migration: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('‚ùå Erreur de connexion lors de la migration', 'error');
            }
        }

        // Charger les statistiques automatiquement quand on ouvre l'onglet optimisation
        const originalShowTab = showTab;
        showTab = function(tabName) {
            originalShowTab(tabName);
            if (tabName === 'optimization') {
                loadOptimizationStats();
            }
        };
    </script>
</body>
</html> 