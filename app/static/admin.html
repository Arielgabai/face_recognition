<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Face Recognition App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        button.success {
            background-color: #28a745;
        }
        button.success:hover {
            background-color: #218838;
        }
        .password-wrapper {
            position: relative;
        }
        .password-wrapper input[type="password"],
        .password-wrapper input[type="text"] {
            padding-right: 40px;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
            white-space: nowrap;
        }
        .tab.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .card h3 {
            margin-top: 0;
            color: #333;
        }
        .qr-code {
            text-align: center;
            margin: 20px 0;
        }
        .qr-code img {
            max-width: 200px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .card-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .card-actions button {
            flex: 1;
            min-width: 80px;
            font-size: 14px;
            padding: 8px 12px;
        }
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .card-actions {
                flex-direction: column;
            }
        }
        
        /* Styles pour l'optimisation des photos */
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .profile-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .profile-card h5 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .profile-card p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #6c757d;
        }
        #estimationResult {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 5px;
            padding: 15px;
        }
        #cleanupResult {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 15px;
        }
    </style>
</head>
<body>
    <div id="perf-metrics" style="position:absolute;left:-9999px;top:-9999px;" aria-hidden="true"
         data-aws-count-indexfaces="0"
         data-aws-count-searchfaces="0"
         data-aws-count-searchfacesbyimage="0"
         data-aws-count-detectfaces="0"
         data-aws-cost-indexfaces="0"
         data-aws-cost-searchfaces="0"
         data-aws-cost-searchfacesbyimage="0"
         data-aws-cost-detectfaces="0"
         data-aws-total-cost="0"
         data-aws-since="">
    </div>
    <div class="container">
        <h1>üëë Administration - Face Recognition App</h1>
        
        <div id="loginForm">
            <h2>Connexion Admin</h2>
            <div class="form-group">
                <label for="username">Nom d'utilisateur:</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">Mot de passe:</label>
                <input type="password" id="password" required>
            </div>
            <button type="button" id="loginButton">Se connecter</button>
        </div>

        <div id="dashboard" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Tableau de bord Admin</h2>
                <button onclick="logout()" class="danger">D√©connexion</button>
            </div>
            
            <div class="stats" id="stats">
                <!-- Les statistiques seront charg√©es ici -->
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('photographers')">üì∏ Photographes</button>
                <button class="tab" onclick="showTab('events')">üéâ √âv√©nements</button>
                <button class="tab" onclick="showTab('qr-codes')">üì± QR Codes</button>
                <button class="tab" onclick="showTab('users')">üë• Utilisateurs</button>
                <button class="tab" onclick="showTab('create-admin')">üë§ Cr√©er Admin</button>
                <button class="tab" onclick="showTab('aws-usage')">üí≤ Co√ªts AWS</button>
                <button class="tab" onclick="showTab('rekog-settings')">‚öôÔ∏è R√©glages Rekognition</button>
                <button class="tab" onclick="showTab('face-groups')">üß© Groupes de visages</button>
                <button class="tab" onclick="showTab('gdrive')">üìÇ Google Drive</button>
            </div>

            <div id="photographers" class="tab-content active">
                <h3>Gestion des Photographes</h3>
                <div class="card">
                    <h4>Cr√©er un nouveau photographe</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="photographerUsername">Nom d'utilisateur:</label>
                            <input type="text" id="photographerUsername" placeholder="ex: photographe1" required>
                        </div>
                        <div class="form-group">
                            <label for="photographerEmail">Email:</label>
                            <input type="email" id="photographerEmail" placeholder="ex: photographe@example.com" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="photographerPassword">Mot de passe:</label>
                        <input type="password" id="photographerPassword" placeholder="Mot de passe s√©curis√©" required>
                    </div>
                    <button onclick="createPhotographer()" class="success">Cr√©er le photographe</button>
                </div>
                
                <div class="card">
                    <h4>Liste des photographes</h4>
                    <div id="photographersList">Chargement...</div>
                </div>
            </div>

            <div id="events" class="tab-content">
                <h3>Gestion des √âv√©nements</h3>
                <div class="card">
                    <h4>Cr√©er un nouvel √©v√©nement</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventName">Nom de l'√©v√©nement:</label>
                            <input type="text" id="eventName" placeholder="ex: Mariage de Marie et Paul" required>
                        </div>
                        <div class="form-group">
                            <label for="eventCode">Code √©v√©nement:</label>
                            <input type="text" id="eventCode" placeholder="ex: MARIAGE2024" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventDate">Date:</label>
                            <input type="date" id="eventDate">
                        </div>
                        <div class="form-group">
                            <label for="eventPhotographer">Photographe assign√©:</label>
                            <select id="eventPhotographer" required>
                                <option value="">S√©lectionner un photographe</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="createNewEvent()" class="success">Cr√©er l'√©v√©nement</button>
                </div>
                
                <div class="card">
                    <h4>Liste des √©v√©nements</h4>
                    <div id="eventsList">Chargement...</div>
                </div>
            </div>

            <div id="qr-codes" class="tab-content">
                <h3>G√©n√©ration de QR Codes</h3>
                <div class="card">
                    <h4>G√©n√©rer un QR Code pour un √©v√©nement</h4>
                    <div class="form-group">
                        <label for="qrEventCode">Code √©v√©nement:</label>
                        <select id="qrEventCode" required>
                            <option value="">S√©lectionner un √©v√©nement</option>
                        </select>
                    </div>
                    <button onclick="generateQRCode()" class="success">G√©n√©rer le QR Code</button>
                    <div id="qrCodeResult"></div>
                </div>
            </div>

            <div id="users" class="tab-content">
                <h3>üë• Utilisateurs par √âv√©nement</h3>
                <div class="card">
                    <h4>S√©lectionner un √©v√©nement</h4>
                    <div class="form-group">
                        <label for="usersEventSelect">√âv√©nement:</label>
                        <select id="usersEventSelect"></select>
                    </div>
                    <button onclick="loadUsersForSelectedEvent()" class="success">Charger les utilisateurs</button>
                </div>
                <div class="card">
                    <h4>Liste des utilisateurs</h4>
                    <div id="usersList">S√©lectionnez un √©v√©nement pour voir les utilisateurs.</div>
                </div>
            </div>

            <div id="create-admin" class="tab-content">
                <h3>Cr√©er un compte Admin</h3>
                <div class="card">
                    <h4>Nouveau compte administrateur</h4>
                    <p style="color: #666; margin-bottom: 20px;">
                        ‚ö†Ô∏è Cette fonctionnalit√© ne peut √™tre utilis√©e qu'une seule fois, 
                        uniquement si aucun admin n'existe encore dans le syst√®me.
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="adminUsername">Nom d'utilisateur:</label>
                            <input type="text" id="adminUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="adminEmail">Email:</label>
                            <input type="email" id="adminEmail" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="adminPassword">Mot de passe:</label>
                        <input type="password" id="adminPassword" required>
                    </div>
                    <button onclick="createAdmin()" class="success">Cr√©er l'admin</button>
                </div>
            </div>

            <div id="aws-usage" class="tab-content">
                <h3>üí≤ Co√ªts AWS Rekognition (estimation)</h3>
                <div class="card">
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                        <button class="success" onclick="refreshAwsUsage()">Rafra√Æchir</button>
                        <button class="danger" onclick="resetAwsUsage()">R√©initialiser</button>
                        <span id="awsSince" style="color:#666;"></span>
                    </div>
                    <div id="awsUsageStats">Chargement...</div>
                </div>
            </div>

            <div id="rekog-settings" class="tab-content">
                <h3>‚öôÔ∏è R√©glages Rekognition</h3>
                <div id="rekogSettingsCard" class="card">Chargement‚Ä¶</div>
            </div>

            <div id="face-groups" class="tab-content">
                <h3>üß© Visualisation des groupes par √©v√©nement</h3>
                <div class="card">
                    <h4>S√©lectionner un √©v√©nement</h4>
                    <div class="form-group">
                        <label for="groupsEventSelect">√âv√©nement:</label>
                        <select id="groupsEventSelect"></select>
                    </div>
                    <div class="card-actions">
                        <button class="success" onclick="loadFaceGroups()">Charger les groupes</button>
                    </div>
                </div>
                <div class="card">
                    <h4>Groupes (DB FaceMatch)</h4>
                    <div id="groupsContainer">S√©lectionnez un √©v√©nement puis chargez les groupes.</div>
                </div>
                <div class="card">
                    <h4>Snapshot Collection Provider</h4>
                    <div class="card-actions">
                        <button onclick="renderSnapshotGraph()">Rafra√Æchir la visualisation</button>
                    </div>
                    <div id="snapshotGraph" class="grid"></div>
                    <pre id="snapshotContainer" style="white-space:pre-wrap; background:#f8f9fa; padding:12px; border-radius:6px; max-height:300px; overflow:auto; margin-top:10px;">‚Äî</pre>
                </div>
                <div class="card">
                    <h4>üîé Chercher par FaceId (AWS)</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="faceIdInput">FaceId source (ex: d2b4...)</label>
                            <input id="faceIdInput" type="text" placeholder="FaceId AWS" />
                        </div>
                        <div class="form-group">
                            <label for="faceIdLimit">Nombre de r√©sultats</label>
                            <input id="faceIdLimit" type="number" min="1" max="50" value="10" />
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="success" onclick="lookupFaceIdMatches()">Voir les correspondances avec cadres</button>
                    </div>
                    <div id="faceIdResults">‚Äî</div>
                </div>
            </div>

            <div id="gdrive" class="tab-content">
                <h3>üìÇ Google Drive ‚Ä¢ Gestion par √©v√©nement</h3>
                <div class="card">
                    <h4>1) Connexion Google (OAuth)</h4>
                    <div class="card-actions">
                        <button onclick="gdriveConnect()">Obtenir l'URL d'autorisation</button>
                        <input id="gdriveCallbackCode" placeholder="Collez le param√®tre code=... de l'URL de retour" />
                        <button onclick="gdriveSubmitCode()" class="success">Enregistrer le code</button>
                    </div>
                    <div id="gdriveIntegrationInfo" style="color:#666;">‚Äî</div>
                    <div id="gdriveCallbackError" style="margin-top:8px; display:none;">
                        <div style="color:#b91c1c; font-weight:600;">D√©tail de l'erreur callback:</div>
                        <pre id="gdriveCallbackErrorBody" style="white-space:pre-wrap;background:#fff0f0;border:1px solid #fca5a5;padding:8px;border-radius:6px;overflow:auto;max-height:200px;"></pre>
                    </div>
                </div>
                <div class="card">
                    <h4>2) G√©rer les int√©grations par √©v√©nement</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="gdriveEventSelect">√âv√©nement</label>
                            <select id="gdriveEventSelect"><option value="">S√©lectionner un √©v√©nement</option></select>
                        </div>
                        <div class="form-group">
                            <label for="gdriveFolderId">ID du dossier Google Drive</label>
                            <input id="gdriveFolderId" placeholder="ex: 1AbCDefG..." />
                        </div>
                        <div class="form-group">
                            <label for="gdriveBatchSize">Taille lot</label>
                            <input id="gdriveBatchSize" type="number" min="1" max="10" value="5" />
                        </div>
                        <div class="form-group">
                            <label for="gdrivePoll">Intervalle (s)</label>
                            <input id="gdrivePoll" type="number" min="5" max="120" value="15" />
                        </div>
                    </div>
                    <div class="card-actions">
                        <button onclick="gdriveLinkFolder()" class="success">Lier / Mettre √† jour</button>
                        <button onclick="gdriveListenStart()">D√©marrer l'√©coute</button>
                        <button onclick="gdriveListenStop()" class="danger">Arr√™ter l'√©coute</button>
                        <button onclick="gdriveSyncNow()">Sync maintenant</button>
                    </div>
                </div>
                <div class="card">
                    <h4>3) Int√©grations existantes (filtr√©es par √©v√©nement)</h4>
                    <div id="gdriveIntegrations">‚Äî</div>
                </div>
                <div class="card">
                    <h4>4) Statut int√©gration s√©lectionn√©e</h4>
                    <div id="gdriveStats">‚Äî</div>
                </div>
                <div class="card">
                    <h4>5) Derniers uploads</h4>
                    <div id="gdriveLogs">‚Äî</div>
                </div>
            </div>

            <div id="face-groups" class="tab-content">
                <h3>üß© Visualisation des groupes par √©v√©nement</h3>
                <div class="card">
                    <h4>S√©lectionner un √©v√©nement</h4>
                    <div class="form-group">
                        <label for="groupsEventSelect">√âv√©nement:</label>
                        <select id="groupsEventSelect"></select>
                    </div>
                    <div class="card-actions">
                        <button class="success" onclick="loadFaceGroups()">Charger les groupes</button>
                    </div>
                </div>
                <div class="card">
                    <h4>Groupes (DB FaceMatch)</h4>
                    <div id="groupsContainer">S√©lectionnez un √©v√©nement puis chargez les groupes.</div>
                </div>
                <div class="card">
                    <h4>Snapshot Collection Provider</h4>
                    <pre id="snapshotContainer" style="white-space:pre-wrap; background:#f8f9fa; padding:12px; border-radius:6px; max-height:300px; overflow:auto;">‚Äî</pre>
                </div>
            </div>
        </div>

        <div id="alert"></div>
    </div>

    <script>
        let currentUser = null;
        let token = localStorage.getItem('token');
        let isLoggingOut = false;
        let dashboardController = null;

        if (token) {
            loadDashboard();
        }

        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert');
            if (!container) return;
            const el = document.createElement('div');
            el.className = `alert alert-${type}`;
            el.textContent = message;
            container.prepend(el);
            setTimeout(() => { try { el.remove(); } catch (e) {} }, 5000);
        }

        function attachPasswordToggle(inputId) {
            const input = document.getElementById(inputId);
            if (!input || input.dataset.toggleAttached === '1') return;
            const wrapper = document.createElement('div');
            wrapper.className = 'password-wrapper';
            input.parentNode.insertBefore(wrapper, input);
            wrapper.appendChild(input);
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'toggle-password';
            btn.setAttribute('aria-label', 'Afficher le mot de passe');
            btn.textContent = 'üëÅÔ∏è';
            btn.addEventListener('click', () => {
                const hidden = input.type === 'password';
                input.type = hidden ? 'text' : 'password';
                btn.textContent = hidden ? 'üôà' : 'üëÅÔ∏è';
            });
            wrapper.appendChild(btn);
            input.dataset.toggleAttached = '1';
        }

        document.addEventListener('DOMContentLoaded', function() {
            attachPasswordToggle('password');
            attachPasswordToggle('photographerPassword');
            attachPasswordToggle('adminPassword');
            try {
                const btn = document.getElementById('loginButton');
                if (btn && !btn.dataset.bound) {
                    btn.addEventListener('click', (e) => login(e));
                    btn.dataset.bound = '1';
                }
                const form = document.getElementById('loginForm');
                if (form && !form.dataset.bound) {
                    form.addEventListener('submit', (e) => login(e));
                    form.dataset.bound = '1';
                }
            } catch (e) {}
        });

        async function login(e) {
            try { if (e && typeof e.preventDefault === 'function') e.preventDefault(); } catch {}
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('token', data.access_token);
                    token = data.access_token;
                    try { await loadDashboard(); } catch {}
                    try { history.replaceState(null, '', location.pathname); } catch {}
                } else {
                    showAlert(data.detail || 'Erreur de connexion', 'error');
                }
            } catch (error) {
                showAlert('Erreur de connexion', 'error');
            }
        }

        // Exposer la fonction au scope global pour le bouton onclick
        try { window.login = login; } catch (e) {}

        async function loadDashboard() {
            // Emp√™che tout chargement si pas de token ou d√©connexion en cours
            if (!localStorage.getItem('token') || !token || isLoggingOut) {
                return;
            }
            try {
                // Annule toute requ√™te pr√©c√©dente
                if (dashboardController) {
                    try { dashboardController.abort(); } catch (e) {}
                }
                dashboardController = new AbortController();

                const response = await fetch('/api/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                    signal: dashboardController.signal
                });

                // V√©rifie encore l'√©tat apr√®s la r√©ponse
                if (!localStorage.getItem('token') || !token || isLoggingOut) {
                    return;
                }
                if (response.ok) {
                    currentUser = await response.json();
                    
                    if (currentUser.user_type !== 'admin') {
                        showAlert('Acc√®s refus√©. Seuls les admins peuvent acc√©der √† cette interface.', 'error');
                        logout();
                        return;
                    }

                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    
                    loadStats();
                    // Fetch and expose recognizer provider to data attribute for QA
                    try {
                        const provResp = await fetch('/api/admin/provider', { headers: { 'Authorization': `Bearer ${token}` } });
                        if (provResp.ok) {
                            const prov = await provResp.json();
                            window.__REC_PROVIDER__ = prov.FACE_RECOGNIZER_PROVIDER || prov.provider_class || 'unknown';
                            document.documentElement.setAttribute('data-rec-provider', window.__REC_PROVIDER__);
                        }
                    } catch (e) {}
                    loadPhotographers();
                    loadEvents();
                } else {
                    localStorage.removeItem('token');
                    token = null;
                }
            } catch (error) {
                console.error('Erreur lors du chargement du dashboard:', error);
            }
        }

        async function loadStats() {
            try {
                const [photographersResponse, eventsResponse] = await Promise.all([
                    fetch('/api/admin/photographers', {
                        headers: { 'Authorization': `Bearer ${token}` },
                    }),
                    fetch('/api/admin/events', {
                        headers: { 'Authorization': `Bearer ${token}` },
                    })
                ]);

                const photographers = photographersResponse.ok ? await photographersResponse.json() : [];
                const events = eventsResponse.ok ? await eventsResponse.json() : [];

                document.getElementById('stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${photographers.length}</div>
                        <div class="stat-label">Photographes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${events.length}</div>
                        <div class="stat-label">√âv√©nements</div>
                    </div>
                `;
                try { refreshAwsUsage(); } catch (e) {}
            } catch (error) {
                console.error('Erreur lors du chargement des stats:', error);
            }
        }

        async function refreshAwsUsage() {
            try {
                const resp = await fetch('/api/admin/aws-usage', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!resp.ok) { document.getElementById('awsUsageStats').textContent = 'Erreur de chargement'; return; }
                const data = await resp.json();
                const since = new Date((data.since || 0) * 1000).toLocaleString();
                const counts = data.counts || {};
                const costs = data.costs || {};
                const actions = data.actions || {};
                const actionLog = data.action_log || [];
                // Expose metrics as data-* tags for QA
                try {
                    const perf = document.getElementById('perf-metrics');
                    if (perf) {
                        perf.dataset.awsCountIndexfaces = String(counts.IndexFaces || 0);
                        perf.dataset.awsCountSearchfaces = String(counts.SearchFaces || 0);
                        perf.dataset.awsCountSearchfacesbyimage = String(counts.SearchFacesByImage || 0);
                        perf.dataset.awsCountDetectfaces = String(counts.DetectFaces || 0);
                        perf.dataset.awsCostIndexfaces = String(costs.IndexFaces || 0);
                        perf.dataset.awsCostSearchfaces = String(costs.SearchFaces || 0);
                        perf.dataset.awsCostSearchfacesbyimage = String(costs.SearchFacesByImage || 0);
                        perf.dataset.awsCostDetectfaces = String(costs.DetectFaces || 0);
                        perf.dataset.awsTotalCost = String(data.total_cost_usd || 0);
                        perf.dataset.awsSince = String(data.since || '');
                    }
                } catch (e) {}
                let rows = '';
                const ops = Object.keys(counts).sort();
                if (ops.length === 0) {
                    rows = '<tr><td colspan="3" style="color:#666; text-align:center;">Aucune donn√©e</td></tr>';
                } else {
                    rows = ops.map(op => `
                        <tr>
                            <td>${op}</td>
                            <td>${counts[op]}</td>
                            <td>$${(costs[op] || 0).toFixed(6)}</td>
                        </tr>
                    `).join('');
                }
                const usageEl = document.getElementById('awsUsageStats');
                if (usageEl) {
                    // Per-operation summary
                    let html = `
                        <h4 style=\"margin:10px 0;\">Par op√©ration</h4>
                        <table style=\"width:100%; border-collapse:collapse;\">\n\
                            <thead>\n\
                                <tr style=\"text-align:left; border-bottom:1px solid #eee;\">\n\
                                    <th>Op√©ration</th>\n\
                                    <th>Appels</th>\n\
                                    <th>Co√ªt estim√©</th>\n\
                                </tr>\n\
                            </thead>\n\
                            <tbody>\n\
                                ${rows}\n\
                                <tr style=\"border-top:1px solid #eee; font-weight:bold;\">\n\
                                    <td>Total</td>\n\
                                    <td>${ops.reduce((s, k) => s + (counts[k] || 0), 0)}</td>\n\
                                    <td>$${(data.total_cost_usd || 0).toFixed(6)}</td>\n\
                                </tr>\n\
                            </tbody>\n\
                        </table>`;
                    // Supprime le tableau agr√©g√© par action, on n'affiche que l'historique
                    // Action log (ligne par action avec horodatage et co√ªt)
                    let logRows = '';
                    if (!actionLog.length) {
                        logRows = '<tr><td colspan="4" style="color:#666; text-align:center;">Aucune action trac√©e</td></tr>';
                    } else {
                        logRows = actionLog.slice().reverse().map(ent => {
                            const when = new Date((ent.ts || 0) * 1000).toLocaleString();
                            const d = ent.description || ent.action;
                            const c = (ent.cost_usd || 0).toFixed(6);
                            const ops = ent.counts || {};
                            const opsTxt = Object.keys(ops).map(k => `${k}:${ops[k]}`).join(', ');
                            return `<tr><td>${when}</td><td>${d}</td><td>${opsTxt}</td><td>$${c}</td></tr>`;
                        }).join('');
                    }
                    html += `
                        <h4 style=\"margin:16px 0 8px;\">Historique des actions</h4>
                        <table style=\"width:100%; border-collapse:collapse;\">\n\
                            <thead>\n\
                                <tr style=\"text-align:left; border-bottom:1px solid #eee;\">\n\
                                    <th>Horodatage</th>\n\
                                    <th>Action</th>\n\
                                    <th>Appels</th>\n\
                                    <th>Co√ªt estim√©</th>\n\
                                </tr>\n\
                            </thead>\n\
                            <tbody>\n\
                                ${logRows}\n\
                            </tbody>\n\
                        </table>`;
                    usageEl.innerHTML = html;
                }
                const sinceEl = document.getElementById('awsSince');
                if (sinceEl) sinceEl.textContent = `Depuis: ${since}`;
            } catch (e) {
                try { document.getElementById('awsUsageStats').textContent = 'Erreur de chargement'; } catch {}
            }
        }

        async function resetAwsUsage() {
            try {
                const resp = await fetch('/api/admin/aws-usage/reset', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                if (resp.ok) {
                    refreshAwsUsage();
                }
            } catch (e) {}
        }

        // === R√©glages Rekognition ===
        function rekogSettingsTemplate(current) {
            return `
              <div>
                <p>Seuil de similarit√© (0‚Äì100). Plus bas = plus de matches (risque de faux positifs).</p>
                <div class="form-group">
                  <label for="rkInput">Seuil actuel: <strong>${current}</strong></label>
                  <input type="number" id="rkInput" min="0" max="100" step="1" value="${current}">
                </div>
                <div class="card-actions">
                  <button class="success" onclick="saveRekogThreshold()">Enregistrer</button>
                  <button onclick="loadRekogThreshold()">Rafra√Æchir</button>
                </div>
              </div>
            `;
        }

        async function loadRekogThreshold() {
            const el = document.getElementById('rekogSettingsCard');
            try {
                const resp = await fetch('/api/admin/rekognition/threshold', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!resp.ok) { el.textContent = 'Erreur de chargement'; return; }
                const data = await resp.json();
                el.innerHTML = rekogSettingsTemplate(Number(data.threshold ?? 50));
            } catch (e) { el.textContent = 'Erreur de chargement'; }
        }

        async function saveRekogThreshold() {
            const val = Number(document.getElementById('rkInput').value);
            const el = document.getElementById('rekogSettingsCard');
            try {
                const resp = await fetch('/api/admin/rekognition/threshold', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value: val })
                });
                if (!resp.ok) { showAlert('Erreur de sauvegarde', 'error'); return; }
                const data = await resp.json();
                el.innerHTML = rekogSettingsTemplate(Number(data.threshold ?? val));
                showAlert('Seuil mis √† jour');
            } catch (e) { showAlert('Erreur de sauvegarde', 'error'); }
        }

        // Hook l‚Äôouverture d‚Äôonglet pour charger les r√©glages
        window.__origShowTabSettings = window.__origShowTabSettings || (window.showTab || function(name) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const tgt = document.getElementById(name);
            if (tgt) tgt.classList.add('active');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        });
        window.showTab = function(tabName) {
            window.__origShowTabSettings(tabName);
            if (tabName === 'rekog-settings') {
                loadRekogThreshold();
            }
            if (tabName === 'face-groups') {
                try { if (!document.getElementById('groupsEventSelect').options.length) loadEvents(); } catch (e) {}
            }
        };

        async function loadPhotographers() {
            try {
                const response = await fetch('/api/admin/photographers', {
                    headers: { 'Authorization': `Bearer ${token}` },
                });

                if (response.ok) {
                    const photographers = await response.json();
                    displayPhotographers(photographers);
                    updatePhotographerSelects(photographers);
                } else {
                    document.getElementById('photographersList').innerHTML = 'Erreur lors du chargement des photographes.';
                }
            } catch (error) {
                console.error('Erreur lors du chargement des photographes:', error);
            }
        }

        function displayPhotographers(photographers) {
            const container = document.getElementById('photographersList');
            
            if (!photographers || photographers.length === 0) {
                container.innerHTML = 'Aucun photographe trouv√©.';
                return;
            }

            container.innerHTML = `
                <div class="grid">
                    ${photographers.map(photographer => `
                        <div class="card">
                            <h4>${photographer.username}</h4>
                            <p><strong>Email:</strong> ${photographer.email}</p>
                            <p><strong>ID:</strong> ${photographer.id}</p>
                            <div class="card-actions">
                                <button onclick="editPhotographer(${photographer.id}, '${photographer.username}', '${photographer.email}')" class="success">Modifier</button>
                                <button onclick="deletePhotographer(${photographer.id}, '${photographer.username}')" class="danger">Supprimer</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updatePhotographerSelects(photographers) {
            const eventPhotographerSelect = document.getElementById('eventPhotographer');
            eventPhotographerSelect.innerHTML = '<option value="">S√©lectionner un photographe</option>';
            
            photographers.forEach(photographer => {
                const option = document.createElement('option');
                option.value = photographer.id;
                option.textContent = `${photographer.username} (${photographer.email})`;
                eventPhotographerSelect.appendChild(option);
            });
        }

        async function loadEvents() {
            try {
                const response = await fetch('/api/admin/events', {
                    headers: { 'Authorization': `Bearer ${token}` },
                });

                if (response.ok) {
                    const events = await response.json();
                    displayEvents(events);
                    updateEventSelects(events);
                } else {
                    document.getElementById('eventsList').innerHTML = 'Erreur lors du chargement des √©v√©nements.';
                }
            } catch (error) {
                console.error('Erreur lors du chargement des √©v√©nements:', error);
            }
        }

        function displayEvents(events) {
            const container = document.getElementById('eventsList');
            
            if (!events || events.length === 0) {
                container.innerHTML = 'Aucun √©v√©nement trouv√©.';
                return;
            }

            container.innerHTML = `
                <div class="grid">
                    ${events.map(event => `
                        <div class="card">
                            <h4>${event.name}</h4>
                            <p><strong>Code:</strong> ${event.event_code}</p>
                            <p><strong>Date:</strong> ${event.date ? new Date(event.date).toLocaleDateString() : 'Non d√©finie'}</p>
                            <p><strong>Photographe ID:</strong> ${event.photographer_id}</p>
                            <div class="card-actions">
                                <button onclick="editEvent(${event.id}, '${event.name}', '${event.event_code}', '${event.date || ''}', ${event.photographer_id})" class="success">Modifier</button>
                                <button onclick="deleteEvent(${event.id}, '${event.name}')" class="danger">Supprimer</button>
                                <button onclick="rematchEvent(${event.id})" class="success">Relancer le matching</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateEventSelects(events) {
            const qrEventSelect = document.getElementById('qrEventCode');
            if (qrEventSelect) {
                qrEventSelect.innerHTML = '<option value="">S√©lectionner un √©v√©nement</option>';
            }
            const usersEventSelect = document.getElementById('usersEventSelect');
            if (usersEventSelect) {
                usersEventSelect.innerHTML = '<option value="">S√©lectionner un √©v√©nement</option>';
            }
            const groupsEventSelect = document.getElementById('groupsEventSelect');
            if (groupsEventSelect) {
                groupsEventSelect.innerHTML = '<option value="">S√©lectionner un √©v√©nement</option>';
            }
            
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.event_code;
                option.textContent = `${event.name} (${event.event_code})`;
                if (qrEventSelect) qrEventSelect.appendChild(option.cloneNode(true));
                if (usersEventSelect) usersEventSelect.appendChild(option);
                if (groupsEventSelect) groupsEventSelect.appendChild(option.cloneNode(true));
            });
        }

        async function loadUsersForSelectedEvent() {
            const usersEventSelect = document.getElementById('usersEventSelect');
            const usersList = document.getElementById('usersList');
            if (!usersEventSelect || !usersList) return;
            const eventCode = usersEventSelect.value;
            if (!eventCode) { usersList.textContent = 'Veuillez s√©lectionner un √©v√©nement.'; return; }
            try {
                // Trouver l'ID de l'√©v√©nement √† partir du code via la liste actuelle
                const eventsResp = await fetch('/api/admin/events', { headers: { 'Authorization': `Bearer ${token}` } });
                const events = eventsResp.ok ? await eventsResp.json() : [];
                const ev = events.find(e => e.event_code === eventCode);
                if (!ev) { usersList.textContent = '√âv√©nement introuvable.'; return; }
                const resp = await fetch(`/api/admin/events/${ev.id}/users`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!resp.ok) { usersList.textContent = 'Erreur lors du chargement des utilisateurs.'; return; }
                const users = await resp.json();
                if (!users || users.length === 0) { usersList.textContent = 'Aucun utilisateur pour cet √©v√©nement.'; return; }
                usersList.innerHTML = `
                    <div class="grid">
                        ${users.map(u => `
                            <div class="card">
                                <h4>${u.username}</h4>
                                <p><strong>Email:</strong> ${u.email}</p>
                                <p><strong>Type:</strong> ${u.user_type}</p>
                                <div class="card-actions">
                                    <button class="danger" onclick="deleteUser(${u.id}, '${u.username}')">Supprimer</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                usersList.textContent = 'Erreur lors du chargement des utilisateurs.';
            }
        }

        // === Google Drive (admin) ===
        let __gdriveIntegrationId = null;
        async function gdriveConnect() {
            try {
                const resp = await fetch('/api/gdrive/connect', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!resp.ok) { showAlert('Erreur: connect', 'error'); return; }
                const data = await resp.json();
                if (data.auth_url) {
                    window.open(data.auth_url, '_blank');
                }
            } catch (e) { showAlert('Erreur connect', 'error'); }
        }

        async function gdriveSubmitCode() {
            const code = document.getElementById('gdriveCallbackCode').value.trim();
            if (!code) { showAlert('Code manquant', 'error'); return; }
            try {
                const url = `/api/gdrive/callback?code=${encodeURIComponent(code)}`;
                const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                // Lire d'abord le texte brut pour couvrir les erreurs non-JSON
                const raw = await resp.text();
                let data;
                try { data = raw ? JSON.parse(raw) : {}; } catch (_) { data = { raw }; }
                if (!resp.ok) {
                    const detail = (data && (data.detail || data.error)) ? (data.detail || data.error) : (data.raw || '(vide)');
                    showAlert(detail || 'Erreur callback', 'error');
                    try {
                        const errBox = document.getElementById('gdriveCallbackError');
                        const errBody = document.getElementById('gdriveCallbackErrorBody');
                        errBody.textContent = `HTTP ${resp.status}\n\n` + (typeof detail === 'string' ? detail : JSON.stringify(detail, null, 2));
                        errBox.style.display = 'block';
                    } catch (e) {}
                    return;
                }
                __gdriveIntegrationId = data.integration_id;
                document.getElementById('gdriveIntegrationInfo').textContent = `Int√©gration cr√©√©e: ID ${__gdriveIntegrationId}`;
                try {
                    const errBox = document.getElementById('gdriveCallbackError');
                    if (errBox) { errBox.style.display = 'none'; }
                } catch (e) {}
                // Pr√©charger les √©v√©nements dans le select gdrive
                try {
                    const eventsResp = await fetch('/api/admin/events', { headers: { 'Authorization': `Bearer ${token}` } });
                    const events = eventsResp.ok ? await eventsResp.json() : [];
                    const sel = document.getElementById('gdriveEventSelect');
                    sel.innerHTML = '<option value="">S√©lectionner un √©v√©nement</option>';
                    events.forEach(ev => {
                        const opt = document.createElement('option');
                        opt.value = ev.id;
                        opt.textContent = `${ev.name} (${ev.event_code})`;
                        sel.appendChild(opt);
                    });
                    loadGdriveIntegrations();
                } catch (e) {}
                showAlert('Google Drive connect√©', 'success');
            } catch (e) { showAlert('Erreur callback', 'error'); }
        }

        async function gdriveLinkFolder() {
            const eventId = Number(document.getElementById('gdriveEventSelect').value);
            const folderId = document.getElementById('gdriveFolderId').value.trim();
            const batchSize = Number(document.getElementById('gdriveBatchSize').value || 5);
            const poll = Number(document.getElementById('gdrivePoll').value || 15);
            if (!__gdriveIntegrationId) { showAlert('Connectez Drive d\'abord', 'error'); return; }
            if (!eventId || !folderId) { showAlert('S√©lectionnez un √©v√©nement et un folder', 'error'); return; }
            try {
                const resp = await fetch('/api/gdrive/link-folder', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ integration_id: __gdriveIntegrationId, event_id: eventId, folder_id: folderId, listening: true, poll_interval_sec: poll, batch_size: batchSize })
                });
                const data = await resp.json();
                if (!resp.ok) { showAlert(data.detail || 'Erreur de liaison', 'error'); return; }
                showAlert('Dossier li√© √† l\'√©v√©nement', 'success');
                loadGdriveIntegrations();
            } catch (e) { showAlert('Erreur de liaison', 'error'); }
        }

        async function gdriveSyncNow() {
            if (!__gdriveIntegrationId) { showAlert('Connectez Drive et enregistrez le code', 'error'); return; }
            try {
                const bs = Number(document.getElementById('gdriveBatchSize').value || 5);
                const resp = await fetch('/api/gdrive/sync-now', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ integration_id: __gdriveIntegrationId, sub_batch_size: bs })
                });
                const data = await resp.json();
                if (!resp.ok) { showAlert(data.detail || 'Erreur sync', 'error'); return; }
                const jobId = data.job_id;
                document.getElementById('gdriveJobStatus').textContent = `Job ${jobId} d√©marr√©‚Ä¶`;
                const poll = async () => {
                    try {
                        const st = await fetch(`/api/gdrive/jobs/${jobId}/status`, { headers: { 'Authorization': `Bearer ${token}` } });
                        if (st.ok) {
                            const d = await st.json();
                            const errArr = Array.isArray(d.errors) ? d.errors : [];
                            const lastErr = errArr.length ? errArr[errArr.length - 1] : null;
                            const statusEl = document.getElementById('gdriveJobStatus');
                            statusEl.innerHTML = `Job ${jobId}: ${d.processed}/${d.total} ‚Ä¢ √©checs: ${d.failed} ‚Ä¢ statut: ${d.status}` +
                              (lastErr ? `<div style="margin-top:6px;color:#b91c1c;">Derni√®re erreur:<pre style="white-space:pre-wrap;background:#fff0f0;border:1px solid #fca5a5;padding:8px;border-radius:6px;">${(lastErr+'').replace(/</g,'&lt;')}</pre></div>` : '');
                            if (d.status === 'done' || d.status === 'error') return;
                        }
                    } catch (e) {}
                    setTimeout(poll, 1500);
                };
                setTimeout(poll, 1500);
                showAlert('Sync d√©marr√©e', 'success');
            } catch (e) { showAlert('Erreur sync', 'error'); }
        }

        async function gdriveListenStart() {
            if (!__gdriveIntegrationId) { showAlert('Connectez Drive et liez un dossier', 'error'); return; }
            try {
                const resp = await fetch('/api/gdrive/listen/start', {
                    method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ integration_id: __gdriveIntegrationId })
                });
                const data = await resp.json();
                if (!resp.ok) { showAlert(data.detail || 'Erreur start listen', 'error'); return; }
                showAlert('√âcoute d√©marr√©e', 'success');
                loadGdriveIntegrations();
            } catch (e) { showAlert('Erreur start listen', 'error'); }
        }

        async function gdriveListenStop() {
            if (!__gdriveIntegrationId) { showAlert('Connectez Drive et liez un dossier', 'error'); return; }
            try {
                const resp = await fetch('/api/gdrive/listen/stop', {
                    method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ integration_id: __gdriveIntegrationId })
                });
                const data = await resp.json();
                if (!resp.ok) { showAlert(data.detail || 'Erreur stop listen', 'error'); return; }
                showAlert('√âcoute arr√™t√©e', 'success');
                loadGdriveIntegrations();
            } catch (e) { showAlert('Erreur stop listen', 'error'); }
        }

        async function loadGdriveIntegrations() {
            try {
                const evId = Number(document.getElementById('gdriveEventSelect').value) || null;
                const url = evId ? `/api/gdrive/integrations?event_id=${evId}` : '/api/gdrive/integrations';
                const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await resp.json();
                const container = document.getElementById('gdriveIntegrations');
                if (!resp.ok) { container.textContent = data.detail || 'Erreur'; return; }
                if (!Array.isArray(data) || data.length === 0) { container.textContent = 'Aucune int√©gration'; return; }
                container.innerHTML = data.map(d => `
                    <div class="item-row">
                        <div>
                            <div><strong>ID:</strong> ${d.id} ${d.event_name ? `‚Äî ${d.event_name}` : ''}</div>
                            <div><strong>Folder:</strong> ${d.folder_id || '-'} | <strong>Listening:</strong> ${d.listening ? 'oui' : 'non'}</div>
                            <div><strong>Batch:</strong> ${d.batch_size || 5} | <strong>Poll:</strong> ${d.poll_interval_sec || 15}s | <strong>Dernier poll:</strong> ${d.last_poll_at || '-'}</div>
                            <div><strong>Status:</strong> ${d.status || '-'}</div>
                        </div>
                        <div>
                            <button onclick="selectIntegration(${d.id})">S√©lectionner</button>
                            <button onclick="deleteIntegration(${d.id})" class="danger">Supprimer</button>
                            ${d.listening ? `<button onclick="stopIntegration(${d.id})">Arr√™ter</button>` : `<button onclick="startIntegration(${d.id})">D√©marrer</button>`}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                const container = document.getElementById('gdriveIntegrations');
                container.textContent = 'Erreur lors du chargement';
            }
        }

        function selectIntegration(id) {
            __gdriveIntegrationId = id;
            showAlert(`Int√©gration ${id} s√©lectionn√©e`, 'success');
            startGdriveStatsPolling();
            loadGdriveLogs();
        }

        async function loadGdriveLogs() {
            if (!__gdriveIntegrationId) { document.getElementById('gdriveLogs').textContent = 'S√©lectionnez une int√©gration'; return; }
            try {
                const resp = await fetch(`/api/gdrive/logs?integration_id=${__gdriveIntegrationId}&limit=20`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await resp.json();
                const container = document.getElementById('gdriveLogs');
                if (!resp.ok) { container.textContent = data.detail || 'Erreur'; return; }
                if (!Array.isArray(data) || data.length === 0) { container.textContent = 'Aucun upload r√©cent'; return; }
                container.innerHTML = data.map(l => `
                    <div class="item-row">
                        <div>
                            <div><strong>${l.status === 'ingested' ? '‚úÖ' : '‚ùå'}</strong> ${l.file_name || l.file_id}</div>
                            <div style="color:#666;">${l.last_seen_at || ''} ‚Äî ${l.error || ''}</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('gdriveLogs').textContent = 'Erreur lors du chargement des logs';
            }
        }

        let __gdriveStatsTimer = null;
        function startGdriveStatsPolling() {
            if (!__gdriveIntegrationId) { document.getElementById('gdriveStats').textContent = 'S√©lectionnez une int√©gration'; return; }
            if (__gdriveStatsTimer) {
                try { clearInterval(__gdriveStatsTimer); } catch (e) {}
                __gdriveStatsTimer = null;
            }
            const tick = async () => {
                try {
                    const resp = await fetch(`/api/gdrive/integrations/${__gdriveIntegrationId}/stats`, { headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await resp.json();
                    const box = document.getElementById('gdriveStats');
                    if (!resp.ok) { box.textContent = data.detail || 'Erreur'; return; }
                    box.innerHTML = `<div style="display:flex; gap:16px; align-items:center;">
                        <div><strong>Total Drive</strong>: ${data.total_drive}</div>
                        <div><strong>Ingest√©s</strong>: ${data.ingested}/${data.total_drive}</div>
                        <div><strong>√âchecs</strong>: ${data.failed}</div>
                        <div><strong>√âcoute</strong>: ${data.listening ? 'oui' : 'non'}</div>
                        <div><strong>Dernier poll</strong>: ${data.last_poll_at || '-'}</div>
                    </div>`;
                } catch (e) {
                    document.getElementById('gdriveStats').textContent = 'Erreur de stats';
                }
            };
            tick();
            __gdriveStatsTimer = setInterval(tick, 5000);
        }

        async function deleteIntegration(id) {
            if (!confirm('Supprimer cette int√©gration ?')) return;
            try {
                const resp = await fetch(`/api/gdrive/integrations/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) { showAlert(data.detail || 'Erreur suppression', 'error'); return; }
                showAlert('Int√©gration supprim√©e', 'success');
                if (__gdriveIntegrationId === id) { __gdriveIntegrationId = null; }
                loadGdriveIntegrations();
                document.getElementById('gdriveLogs').textContent = '‚Äî';
            } catch (e) { showAlert('Erreur suppression', 'error'); }
        }

        async function startIntegration(id) {
            try {
                const resp = await fetch('/api/gdrive/listen/start', { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ integration_id: id }) });
                const data = await resp.json();
                if (!resp.ok) { showAlert(data.detail || 'Erreur d√©marrage', 'error'); return; }
                showAlert('√âcoute d√©marr√©e', 'success');
                loadGdriveIntegrations();
            } catch (e) { showAlert('Erreur d√©marrage', 'error'); }
        }

        async function stopIntegration(id) {
            try {
                const resp = await fetch('/api/gdrive/listen/stop', { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ integration_id: id }) });
                const data = await resp.json();
                if (!resp.ok) { showAlert(data.detail || 'Erreur arr√™t', 'error'); return; }
                showAlert('√âcoute arr√™t√©e', 'success');
                loadGdriveIntegrations();
            } catch (e) { showAlert('Erreur arr√™t', 'error'); }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`Supprimer l'utilisateur "${username}" ? Cette action est irr√©versible.`)) return;
            try {
                const resp = await fetch(`/api/admin/users/${userId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) { showAlert(data.detail || 'Erreur lors de la suppression', 'error'); return; }
                showAlert('Utilisateur supprim√© avec succ√®s', 'success');
                loadUsersForSelectedEvent();
            } catch (e) {
                showAlert('Erreur lors de la suppression', 'error');
            }
        }

        async function createNewEvent() {
            console.log('createNewEvent() appel√©e');
            const name = document.getElementById('eventName').value;
            const eventCode = document.getElementById('eventCode').value;
            const date = document.getElementById('eventDate').value;
            const photographerId = document.getElementById('eventPhotographer').value;

            console.log('Valeurs:', { name, eventCode, date, photographerId, token });

            if (!name || !eventCode || !photographerId) {
                showAlert('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }

            try {
                console.log('Envoi de la requ√™te...');
                const response = await fetch('/api/admin/create-event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ 
                        name, 
                        event_code: eventCode, 
                        date: date || null, 
                        photographer_id: parseInt(photographerId) 
                    }),
                });

                console.log('R√©ponse re√ßue:', response.status);
                const data = await response.json();
                console.log('Donn√©es re√ßues:', data);

                if (response.ok) {
                    showAlert('√âv√©nement cr√©√© avec succ√®s !', 'success');
                    // Vider les champs
                    document.getElementById('eventName').value = '';
                    document.getElementById('eventCode').value = '';
                    document.getElementById('eventDate').value = '';
                    document.getElementById('eventPhotographer').value = '';
                    // Recharger les listes
                    loadEvents();
                    loadStats();
                } else {
                    showAlert(data.detail || 'Erreur lors de la cr√©ation', 'error');
                }
            } catch (error) {
                console.error('Erreur dans createNewEvent:', error);
                showAlert('Erreur lors de la cr√©ation', 'error');
            }
        }

        async function generateQRCode() {
            const eventCode = document.getElementById('qrEventCode').value;

            if (!eventCode) {
                showAlert('Veuillez s√©lectionner un √©v√©nement', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/admin/event-qr/${eventCode}`, {
                    headers: { 'Authorization': `Bearer ${token}` },
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const imageUrl = URL.createObjectURL(blob);
                    
                    document.getElementById('qrCodeResult').innerHTML = `
                        <div class="qr-code">
                            <h4>QR Code pour l'√©v√©nement ${eventCode}</h4>
                            <img src="${imageUrl}" alt="QR Code">
                            <p style="margin-top: 10px; color: #666;">
                                Les invit√©s peuvent scanner ce QR code pour s'inscrire √† l'√©v√©nement.
                            </p>
                        </div>
                    `;
                } else {
                    showAlert('Erreur lors de la g√©n√©ration du QR code', 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la g√©n√©ration du QR code', 'error');
            }
        }

        async function createAdmin() {
            const username = document.getElementById('adminUsername').value;
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            if (!username || !email || !password) {
                showAlert('Veuillez remplir tous les champs', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/create-admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ username, email, password }),
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Admin cr√©√© avec succ√®s !', 'success');
                    // Vider les champs
                    document.getElementById('adminUsername').value = '';
                    document.getElementById('adminEmail').value = '';
                    document.getElementById('adminPassword').value = '';
                } else {
                    showAlert(data.detail || 'Erreur lors de la cr√©ation', 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la cr√©ation', 'error');
            }
        }

        // === FONCTIONS POUR LA GESTION DES PHOTOGRAPHES ===

        async function createPhotographer() {
            const username = document.getElementById('photographerUsername').value;
            const email = document.getElementById('photographerEmail').value;
            const password = document.getElementById('photographerPassword').value;

            if (!username || !email || !password) {
                showAlert('Veuillez remplir tous les champs', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/photographers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ username, email, password }),
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Photographe cr√©√© avec succ√®s !', 'success');
                    // Vider les champs
                    document.getElementById('photographerUsername').value = '';
                    document.getElementById('photographerEmail').value = '';
                    document.getElementById('photographerPassword').value = '';
                    loadPhotographers(); // Recharger la liste des photographes
                    loadStats(); // Mettre √† jour les statistiques
                } else {
                    showAlert(data.detail || 'Erreur lors de la cr√©ation', 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la cr√©ation', 'error');
            }
        }

        async function deletePhotographer(photographerId, photographerName) {
            console.log('deletePhotographer() appel√©e:', photographerId, photographerName);
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le photographe "${photographerName}" ?`)) {
                return;
            }

            try {
                console.log('Envoi de la requ√™te DELETE...');
                const response = await fetch(`/api/admin/photographers/${photographerId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` },
                });

                console.log('R√©ponse DELETE re√ßue:', response.status);
                const data = await response.json();
                console.log('Donn√©es DELETE re√ßues:', data);

                if (response.ok) {
                    showAlert('Photographe supprim√© avec succ√®s !', 'success');
                    loadPhotographers();
                    loadStats();
                } else {
                    showAlert(data.detail || 'Erreur lors de la suppression', 'error');
                }
            } catch (error) {
                console.error('Erreur dans deletePhotographer:', error);
                showAlert('Erreur lors de la suppression', 'error');
            }
        }

        async function editPhotographer(photographerId, currentUsername, currentEmail) {
            const newUsername = prompt('Nouveau nom d\'utilisateur:', currentUsername);
            if (!newUsername) return;

            const newEmail = prompt('Nouvel email:', currentEmail);
            if (!newEmail) return;

            try {
                const response = await fetch(`/api/admin/photographers/${photographerId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ username: newUsername, email: newEmail }),
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Photographe modifi√© avec succ√®s !', 'success');
                    loadPhotographers();
                } else {
                    showAlert(data.detail || 'Erreur lors de la modification', 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la modification', 'error');
            }
        }

        // === FONCTIONS POUR LA GESTION DES √âV√âNEMENTS ===

        async function deleteEvent(eventId, eventName) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'√©v√©nement "${eventName}" ?\n\n‚ö†Ô∏è ATTENTION: Cette action supprimera √©galement toutes les photos associ√©es √† cet √©v√©nement !`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/events/${eventId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` },
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('√âv√©nement supprim√© avec succ√®s !', 'success');
                    loadEvents();
                    loadStats();
                } else {
                    showAlert(data.detail || 'Erreur lors de la suppression', 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la suppression', 'error');
            }
        }

        async function editEvent(eventId, currentName, currentEventCode, currentDate, currentPhotographerId) {
            const newName = prompt('Nouveau nom de l\'√©v√©nement:', currentName);
            if (!newName) return;

            const newEventCode = prompt('Nouveau code √©v√©nement:', currentEventCode);
            if (!newEventCode) return;

            const newDate = prompt('Nouvelle date (YYYY-MM-DD, laissez vide si pas de date):', currentDate);
            
            // Charger les photographes pour la s√©lection
            try {
                const photographersResponse = await fetch('/api/admin/photographers', {
                    headers: { 'Authorization': `Bearer ${token}` },
                });
                
                if (!photographersResponse.ok) {
                    showAlert('Erreur lors du chargement des photographes', 'error');
                    return;
                }
                
                const photographers = await photographersResponse.json();
                const photographerOptions = photographers.map(p => `${p.id}: ${p.username}`).join('\n');
                const newPhotographerId = prompt(`Nouveau photographe (ID actuel: ${currentPhotographerId}):\n\nPhotographes disponibles:\n${photographerOptions}`, currentPhotographerId);
                
                if (!newPhotographerId) return;

                const response = await fetch(`/api/admin/events/${eventId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ 
                        name: newName, 
                        event_code: newEventCode, 
                        date: newDate || null, 
                        photographer_id: parseInt(newPhotographerId) 
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('√âv√©nement modifi√© avec succ√®s !', 'success');
                    loadEvents();
                } else {
                    showAlert(data.detail || 'Erreur lors de la modification', 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la modification', 'error');
            }
        }

        async function rematchEvent(eventId) {
            try {
                const resp = await fetch(`/api/admin/events/${eventId}/rematch`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                });
                if (!resp.ok) {
                    const data = await resp.json().catch(() => ({}));
                    showAlert(data.detail || 'Erreur lors du rematch', 'error');
                    return;
                }
                showAlert('Matching relanc√© pour cet √©v√©nement', 'success');
            } catch (e) {
                showAlert('Erreur lors de l\'appel rematch', 'error');
            }
        }

        async function loadFaceGroups() {
            const groupsEventSelect = document.getElementById('groupsEventSelect');
            const groupsContainer = document.getElementById('groupsContainer');
            const snapshotContainer = document.getElementById('snapshotContainer');
            if (!groupsEventSelect) return;
            const eventCode = groupsEventSelect.value;
            if (!eventCode) { groupsContainer.textContent = 'Veuillez s√©lectionner un √©v√©nement.'; return; }
            try {
                const eventsResp = await fetch('/api/admin/events', { headers: { 'Authorization': `Bearer ${token}` } });
                const events = eventsResp.ok ? await eventsResp.json() : [];
                const ev = events.find(e => e.event_code === eventCode);
                if (!ev) { groupsContainer.textContent = '√âv√©nement introuvable.'; return; }
                const resp = await fetch(`/api/admin/events/${ev.id}/face-groups`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!resp.ok) { groupsContainer.textContent = 'Erreur lors du chargement des groupes.'; return; }
                const data = await resp.json();

                // Render DB groups
                const groups = data.groups || {};
                const samples = data.samples || {};
                const userIds = Object.keys(groups).sort((a,b)=>Number(a)-Number(b));
                if (!userIds.length) {
                    groupsContainer.innerHTML = '<div style="color:#666;">Aucun groupe trouv√© (FaceMatch vide).</div>';
                } else {
                    groupsContainer.innerHTML = `
                        <div class="grid">
                            ${userIds.map(uid => {
                                const g = groups[uid] || {}; 
                                const best = g.best_score || 0;
                                const photoIds = (samples[uid] || []).map(pid => `<img src="/api/photo/${pid}" alt="${pid}" style="width:100%; max-width:160px; border-radius:6px; border:1px solid #eee; margin:4px;">`).join('');
                                return `
                                  <div class="card">
                                    <h4>User #${uid}</h4>
                                    <p><strong>Taille groupe:</strong> ${g.count || 0}</p>
                                    <p><strong>Meilleur score:</strong> ${best}</p>
                                    <div class="card-actions">
                                      <button class="success" onclick="loadUserGroupBoxes(${uid})">Afficher les cadres sur toutes les photos</button>
                                    </div>
                                    <div style="display:flex; flex-wrap:wrap; gap:8px;">${photoIds}</div>
                                    <div id="userGroupBoxes_${uid}"></div>
                                    <div style="margin-top:10px;">
                                      <span style="color:#666;">Selfie:</span><br/>
                                      <img src="/api/selfie/${uid}" onerror="this.style.display='none'" style="width:96px;height:96px;object-fit:cover;border-radius:8px;border:1px solid #eee;" />
                                    </div>
                                  </div>`;
                            }).join('')}
                        </div>`;
                }

                // Render snapshot (JSON) + visual graph refresh
                try {
                    snapshotContainer.textContent = JSON.stringify(data.provider_snapshot || { note: 'Pas de snapshot disponible' }, null, 2);
                } catch (e) {
                    snapshotContainer.textContent = 'Erreur de rendu du snapshot';
                }
                try { await renderSnapshotGraph(); } catch (e) {}
            } catch (e) {
                groupsContainer.textContent = 'Erreur lors du chargement des groupes.';
                try { snapshotContainer.textContent = '‚Äî'; } catch {}
            }
        }

        async function renderSnapshotGraph() {
            const groupsEventSelect = document.getElementById('groupsEventSelect');
            const eventCode = groupsEventSelect?.value;
            const graphEl = document.getElementById('snapshotGraph');
            if (!graphEl) return;
            if (!eventCode) { graphEl.innerHTML = '<div style="color:#666;">S√©lectionnez un √©v√©nement.</div>'; return; }
            try {
                const eventsResp = await fetch('/api/admin/events', { headers: { 'Authorization': `Bearer ${token}` } });
                const events = eventsResp.ok ? await eventsResp.json() : [];
                const ev = events.find(e => e.event_code === eventCode);
                if (!ev) { graphEl.innerHTML = '<div style="color:#666;">√âv√©nement introuvable.</div>'; return; }
                const resp = await fetch(`/api/admin/events/${ev.id}/snapshot-graph`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!resp.ok) { graphEl.innerHTML = '<div style="color:#666;">Erreur chargement snapshot.</div>'; return; }
                const graph = await resp.json();
                const users = (graph.users || []).slice().sort((a,b)=>a.user_id - b.user_id);
                if (!users.length) { graphEl.innerHTML = '<div style="color:#666;">Aucun utilisateur.</div>'; return; }
                graphEl.innerHTML = `
                  ${users.map(u => {
                    const faces = (u.faces || []).slice().sort((a,b)=> (b.similarity||0) - (a.similarity||0));
                    const cards = faces.map(item => {
                        const pid = item.photo_id;
                        const bb = item.box || {Left:0,Top:0,Width:0,Height:0};
                        const left = (bb.Left * 100).toFixed(2);
                        const top = (bb.Top * 100).toFixed(2);
                        const width = (bb.Width * 100).toFixed(2);
                        const height = (bb.Height * 100).toFixed(2);
                        return `
                          <div class=\"card\" style=\"position:relative;\">
                            <div style=\"position:relative; display:inline-block; max-width:100%;\">
                              <img src=\"/api/photo/${pid}\" alt=\"photo ${pid}\" style=\"max-width:100%; border-radius:6px; border:1px solid #eee;\" />
                              <div style=\"position:absolute; left:${left}%; top:${top}%; width:${width}%; height:${height}%; border:3px solid #22c55e; box-shadow:0 0 0 2px rgba(34,197,94,0.3) inset; border-radius:4px; pointer-events:none;\"></div>
                            </div>
                            <div style=\"margin-top:8px; color:#555;\">
                              <div><strong>Photo #${pid}</strong></div>
                              ${typeof item.similarity === 'number' ? `<div>Similitude: ${item.similarity}%</div>` : ''}
                            </div>
                          </div>`;
                    }).join('');
                    return `
                      <div class=\"card\">
                        <h4>User #${u.user_id} ${u.selfie_available ? 'üì∏' : ''}</h4>
                        <div class=\"grid\">${cards || ''}</div>
                        <div class=\"card-actions\">
                          <button onclick=\"renderFacesSimilarities(${u.user_id})\">Voir toutes les similarit√©s (toutes faces)</button>
                          <button onclick=\"renderDiagnosis(${u.user_id})\">Diagnostiquer (AWS vs DB)</button>
                        </div>
                        <div id=\"facesSimilarities_${u.user_id}\"></div>
                        <div id=\"diagnosis_${u.user_id}\"></div>
                      </div>`;
                  }).join('')}
                `;
            } catch (e) {
                graphEl.innerHTML = '<div style="color:#666;">Erreur chargement snapshot.</div>';
            }
        }

        async function renderFacesSimilarities(uid) {
            const groupsEventSelect = document.getElementById('groupsEventSelect');
            const eventCode = groupsEventSelect?.value;
            const container = document.getElementById(`facesSimilarities_${uid}`);
            if (!container) return;
            if (!eventCode) { container.textContent = 'S√©lectionnez un √©v√©nement.'; return; }
            try {
                const eventsResp = await fetch('/api/admin/events', { headers: { 'Authorization': `Bearer ${token}` } });
                const events = eventsResp.ok ? await eventsResp.json() : [];
                const ev = events.find(e => e.event_code === eventCode);
                if (!ev) { container.textContent = '√âv√©nement introuvable.'; return; }
                container.textContent = 'Calcul des similarit√©s‚Ä¶';
                const resp = await fetch(`/api/admin/events/${ev.id}/faces-similarities?user_id=${uid}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!resp.ok) { container.textContent = 'Erreur de calcul.'; return; }
                const data = await resp.json();
                const photos = data.photos || [];
                if (!photos.length) { container.textContent = 'Aucune donn√©e.'; return; }
                container.innerHTML = `
                  <div class=\"grid\">
                    ${photos.map(ph => {
                        const overlays = (ph.faces || []).map((f, idx) => {
                            const left = (f.box?.Left * 100).toFixed(2);
                            const top = (f.box?.Top * 100).toFixed(2);
                            const width = (f.box?.Width * 100).toFixed(2);
                            const height = (f.box?.Height * 100).toFixed(2);
                            const sim = (typeof f.similarity === 'number') ? f.similarity.toFixed(2) : '-';
                            const color = f.matched ? '#22c55e' : '#999999';
                            const bg = f.matched ? 'rgba(34,197,94,0.9)' : 'rgba(60,60,60,0.85)';
                            const label = f.matched ? `‚úÖ ${sim}%` : `${sim}%`;
                            return `
                              <div style=\"position:absolute; left:${left}%; top:${top}%; width:${width}%; height:${height}%; border:2px solid ${color}; border-radius:4px; pointer-events:none; box-shadow:0 0 0 1px rgba(0,0,0,0.1) inset;\"></div>
                              <div style=\"position:absolute; left:calc(${left}% + 2px); top:calc(${top}% + 2px); transform:translate(0, -110%); background:${bg}; color:white; font-size:12px; padding:2px 6px; border-radius:4px; white-space:nowrap; pointer-events:none;\">${label}</div>
                            `;
                        }).join('');
                        return `
                          <div class=\"card\" style=\"position:relative;\">
                            <div style=\"position:relative; display:inline-block; max-width:100%;\">
                              <img src=\"/api/photo/${ph.photo_id}\" alt=\"photo ${ph.photo_id}\" style=\"max-width:100%; border-radius:6px; border:1px solid #eee; display:block;\" />
                              ${overlays}
                            </div>
                            <div style=\"margin-top:6px;\"><strong>Photo #${ph.photo_id}</strong></div>
                          </div>`;
                    }).join('')}
                  </div>`;
            } catch (e) {
                container.textContent = 'Erreur de calcul.';
            }
        }

        async function renderDiagnosis(uid) {
            const groupsEventSelect = document.getElementById('groupsEventSelect');
            const eventCode = groupsEventSelect?.value;
            const container = document.getElementById(`diagnosis_${uid}`);
            if (!container) return;
            if (!eventCode) { container.textContent = 'S√©lectionnez un √©v√©nement.'; return; }
            try {
                const eventsResp = await fetch('/api/admin/events', { headers: { 'Authorization': `Bearer ${token}` } });
                const events = eventsResp.ok ? await eventsResp.json() : [];
                const ev = events.find(e => e.event_code === eventCode);
                if (!ev) { container.textContent = '√âv√©nement introuvable.'; return; }
                container.textContent = 'Diagnostic en cours‚Ä¶';
                const resp = await fetch(`/api/admin/events/${ev.id}/diagnose-matching?user_id=${uid}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!resp.ok) { container.textContent = 'Erreur de diagnostic.'; return; }
                const data = await resp.json();
                const cm = data.collection_matches || [];
                const dbm = data.db_matches || [];
                const miss = data.missing_in_db || [];
                const filt = data.filtered_out || [];
                container.innerHTML = `
                  <div style=\"margin-top:8px;\">
                    <div style=\"font-size:14px;\"><strong>R√©sultats AWS (collection)</strong>: ${cm.length}</div>
                    <div style=\"font-size:14px;\"><strong>En DB (face_matches)</strong>: ${dbm.length}</div>
                    <div style=\"font-size:14px; color:${miss.length?'#e11d48':'#16a34a'};\"><strong>Manquants en DB</strong>: ${miss.length}</div>
                    ${miss.length ? `<div style=\"margin:6px 0; font-size:13px;\">${miss.map(m => `#${m.photo_id} (${(m.similarity??0).toFixed ? m.similarity.toFixed(2) : m.similarity}%)`).join(', ')}</div>` : ''}
                    ${filt.length ? `<div style=\"font-size:13px; color:#6b7280;\"><strong>Filtr√©s</strong>: ${filt.map(f => `#${f.photo_id} [${f.reason}]`).join(', ')}</div>` : ''}
                  </div>`;
            } catch (e) {
                container.textContent = 'Erreur de diagnostic.';
            }
        }

        async function lookupFaceIdMatches() {
            const faceId = (document.getElementById('faceIdInput')?.value || '').trim();
            const limit = Number(document.getElementById('faceIdLimit')?.value || 10) || 10;
            const resultsEl = document.getElementById('faceIdResults');
            const groupsEventSelect = document.getElementById('groupsEventSelect');
            if (!faceId) { if (resultsEl) resultsEl.textContent = 'Veuillez saisir un FaceId.'; return; }
            const eventCode = groupsEventSelect?.value;
            if (!eventCode) { if (resultsEl) resultsEl.textContent = 'Veuillez s√©lectionner un √©v√©nement.'; return; }
            try {
                const eventsResp = await fetch('/api/admin/events', { headers: { 'Authorization': `Bearer ${token}` } });
                const events = eventsResp.ok ? await eventsResp.json() : [];
                const ev = events.find(e => e.event_code === eventCode);
                if (!ev) { resultsEl.textContent = '√âv√©nement introuvable.'; return; }
                const resp = await fetch(`/api/admin/events/${ev.id}/face-matches?face_id=${encodeURIComponent(faceId)}&limit=${limit}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!resp.ok) { resultsEl.textContent = 'Erreur lors de la recherche.'; return; }
                const data = await resp.json();
                const list = data.results || [];
                if (!list.length) { resultsEl.textContent = 'Aucun r√©sultat.'; return; }
                resultsEl.innerHTML = `
                  <div class="grid">
                    ${list.map(item => {
                        const pid = item.photo_id;
                        const bb = item.box || {Left:0,Top:0,Width:0,Height:0};
                        const left = (bb.Left * 100).toFixed(2);
                        const top = (bb.Top * 100).toFixed(2);
                        const width = (bb.Width * 100).toFixed(2);
                        const height = (bb.Height * 100).toFixed(2);
                        return `
                          <div class="card" style="position:relative;">
                            <div style="position:relative; display:inline-block; max-width:100%;">
                              <img src="/api/photo/${pid}" alt="photo ${pid}" style="max-width:100%; border-radius:6px; border:1px solid #eee;" />
                              <div style="position:absolute; left:${left}%; top:${top}%; width:${width}%; height:${height}%; border:3px solid #ff3b30; box-shadow:0 0 0 2px rgba(255,59,48,0.3) inset; border-radius:4px; pointer-events:none;"></div>
                            </div>
                            <div style="margin-top:8px; color:#555;">
                              <div><strong>Photo #${pid}</strong></div>
                              <div>Similitude: ${item.similarity}%</div>
                              <div>FaceId(photo): ${item.face_id_photo}</div>
                            </div>
                          </div>`;
                    }).join('')}
                  </div>`;
            } catch (e) {
                if (resultsEl) resultsEl.textContent = 'Erreur lors de la recherche.';
            }
        }

        async function loadUserGroupBoxes(uid) {
            const groupsEventSelect = document.getElementById('groupsEventSelect');
            const eventCode = groupsEventSelect?.value;
            const container = document.getElementById(`userGroupBoxes_${uid}`);
            if (!container) return;
            if (!eventCode) { container.textContent = 'Veuillez s√©lectionner un √©v√©nement.'; return; }
            try {
                const eventsResp = await fetch('/api/admin/events', { headers: { 'Authorization': `Bearer ${token}` } });
                const events = eventsResp.ok ? await eventsResp.json() : [];
                const ev = events.find(e => e.event_code === eventCode);
                if (!ev) { container.textContent = '√âv√©nement introuvable.'; return; }
                container.textContent = 'Chargement‚Ä¶';
                const resp = await fetch(`/api/admin/events/${ev.id}/users/${uid}/group-faces`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!resp.ok) { container.textContent = 'Erreur lors du chargement.'; return; }
                const data = await resp.json();
                const list = data.results || [];
                if (!list.length) { container.textContent = 'Aucune photo dans ce groupe.'; return; }
                container.innerHTML = `
                  <div class="grid">
                    ${list.map(item => {
                        const pid = item.photo_id;
                        const bb = item.box || {Left:0,Top:0,Width:0,Height:0};
                        const left = (bb.Left * 100).toFixed(2);
                        const top = (bb.Top * 100).toFixed(2);
                        const width = (bb.Width * 100).toFixed(2);
                        const height = (bb.Height * 100).toFixed(2);
                        return `
                          <div class="card" style="position:relative;">
                            <div style="position:relative; display:inline-block; max-width:100%;">
                              <img src="/api/photo/${pid}" alt="photo ${pid}" style="max-width:100%; border-radius:6px; border:1px solid #eee;" />
                              <div style="position:absolute; left:${left}%; top:${top}%; width:${width}%; height:${height}%; border:3px solid #007bff; box-shadow:0 0 0 2px rgba(0,123,255,0.3) inset; border-radius:4px; pointer-events:none;"></div>
                            </div>
                            <div style="margin-top:8px; color:#555;">
                              <div><strong>Photo #${pid}</strong></div>
                            </div>
                          </div>`;
                    }).join('')}
                  </div>`;
            } catch (e) {
                container.textContent = 'Erreur lors du chargement.';
            }
        }

        async function showTab(tabName) {
            // Masquer tous les contenus d'onglets
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // D√©sactiver tous les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Afficher le contenu de l'onglet s√©lectionn√©
            document.getElementById(tabName).classList.add('active');
            
            // Activer l'onglet s√©lectionn√©
            event.target.classList.add('active');

            // Initialisation sp√©cifique √† certains onglets
            if (tabName === 'gdrive') {
                try {
                    await loadGdriveEvents();
                } catch (e) {}
                try { await loadGdriveIntegrations(); } catch (e) {}
                // (r√©)attacher le change du select pour filtrer
                try {
                    const sel = document.getElementById('gdriveEventSelect');
                    if (sel && !sel.dataset.bound) {
                        sel.addEventListener('change', () => loadGdriveIntegrations());
                        sel.dataset.bound = '1';
                    }
                } catch (e) {}
            }
        }

        async function loadGdriveEvents() {
            try {
                const eventsResp = await fetch('/api/admin/events', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!eventsResp.ok) return;
                const events = await eventsResp.json();
                const sel = document.getElementById('gdriveEventSelect');
                if (!sel) return;
                const current = sel.value;
                sel.innerHTML = '<option value="">S√©lectionner un √©v√©nement</option>';
                events.forEach(ev => {
                    const opt = document.createElement('option');
                    opt.value = ev.id;
                    opt.textContent = `${ev.name} (${ev.event_code})`;
                    sel.appendChild(opt);
                });
                if (current) {
                    try { sel.value = current; } catch (e) {}
                }
            } catch (e) {}
        }

        function logout() {
            isLoggingOut = true;
            // Annuler les requ√™tes en cours
            if (dashboardController) {
                try { dashboardController.abort(); } catch (e) {}
                dashboardController = null;
            }
            // Nettoyer compl√®tement le localStorage
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('currentUser');
            
            // R√©initialiser les variables
            token = null;
            currentUser = null;
            
            // Nettoyer les champs du formulaire de connexion
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            if (usernameInput) usernameInput.value = '';
            if (passwordInput) passwordInput.value = '';
            
            // Masquer le dashboard et afficher le formulaire de connexion
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            
            // Nettoyer l'affichage
            document.getElementById('stats').innerHTML = '';
            document.getElementById('photographersList').innerHTML = '';
            document.getElementById('eventsList').innerHTML = '';
            
            // Nettoyer les autres √©l√©ments d'affichage
            document.getElementById('qrCodeResult').innerHTML = '';
            document.getElementById('estimationResult').innerHTML = '';
            document.getElementById('cleanupResult').innerHTML = '';
            
            // R√©initialiser les onglets
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // R√©activer le premier onglet
            document.getElementById('photographers').classList.add('active');
            document.querySelector('.tab').classList.add('active');
            
            // Afficher un message de confirmation
            showAlert('D√©connexion r√©ussie', 'success');
            
            console.log('D√©connexion effectu√©e - session nettoy√©e');
            // Autoriser une future reconnexion
            isLoggingOut = false;
        }

        // === FONCTIONS D'OPTIMISATION DES PHOTOS ===

        async function loadOptimizationStats() {
            try {
                const response = await fetch('/api/admin/photo-optimization/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    
                    document.getElementById('totalPhotos').textContent = stats.total_photos;
                    document.getElementById('totalSpaceSaved').textContent = stats.total_space_saved_mb + ' MB';
                    document.getElementById('avgCompression').textContent = stats.average_compression_ratio + '%';
                    document.getElementById('expiredPhotos').textContent = stats.expired_photos_count;
                    
                    showAlert('‚úÖ Statistiques mises √† jour', 'success');
                } else {
                    showAlert('‚ùå Erreur lors du chargement des statistiques', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('‚ùå Erreur de connexion', 'error');
            }
        }

        async function estimateCompression() {
            const fileSize = document.getElementById('fileSize').value;
            const qualityProfile = document.getElementById('qualityProfile').value;
            
            if (!fileSize || fileSize <= 0) {
                showAlert('‚ùå Veuillez entrer une taille de fichier valide', 'error');
                return;
            }

            try {
                const fileSizeBytes = parseFloat(fileSize) * 1024 * 1024; // Convertir MB en bytes
                const response = await fetch(`/api/admin/photo-optimization/estimate?file_size=${fileSizeBytes}&quality_profile=${qualityProfile}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const estimation = await response.json();
                    
                    document.getElementById('estimationResult').innerHTML = `
                        <h5>üìä R√©sultats de l'estimation:</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                            <div><strong>Taille originale:</strong><br/>${estimation.original_size_mb} MB</div>
                            <div><strong>Taille compress√©e:</strong><br/>${estimation.estimated_compressed_size_mb} MB</div>
                            <div><strong>Espace √©conomis√©:</strong><br/>${estimation.estimated_space_saved_mb} MB</div>
                            <div><strong>Compression:</strong><br/>${estimation.estimated_compression_ratio}%</div>
                        </div>
                        <p style="margin-top: 10px; color: #666;">
                            <em>Profil utilis√©: ${estimation.quality_profile}</em>
                        </p>
                    `;
                } else {
                    showAlert('‚ùå Erreur lors de l\'estimation', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('‚ùå Erreur de connexion', 'error');
            }
        }

        async function cleanupExpiredPhotos() {
            if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer toutes les photos expir√©es ? Cette action est irr√©versible.')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/photo-optimization/cleanup-expired', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    document.getElementById('cleanupResult').innerHTML = `
                        <h5>‚úÖ ${result.message}</h5>
                        <p><strong>Photos supprim√©es:</strong> ${result.deleted_count}</p>
                        <p><strong>Espace lib√©r√©:</strong> ${result.space_freed_mb} MB</p>
                    `;
                    
                    showAlert('‚úÖ Nettoyage termin√© avec succ√®s', 'success');
                    
                    // Recharger les statistiques
                    loadOptimizationStats();
                } else {
                    const error = await response.json();
                    showAlert(`‚ùå ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('‚ùå Erreur de connexion', 'error');
            }
        }

        async function runMigration() {
            if (!confirm('‚öôÔ∏è √ätes-vous s√ªr de vouloir ex√©cuter la migration de la base de donn√©es ? Cette op√©ration va ajouter les colonnes d\'optimisation manquantes.')) {
                return;
            }

            try {
                showAlert('üîÑ Migration en cours...', 'info');
                
                const response = await fetch('/api/admin/migrate-photo-optimization', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    let logDisplay = result.log.map(line => `<p>‚Ä¢ ${line}</p>`).join('');
                    
                    document.getElementById('cleanupResult').innerHTML = `
                        <h5>‚úÖ ${result.message}</h5>
                        <p><strong>Photos mises √† jour:</strong> ${result.photos_updated}</p>
                        <p><strong>Total photos avec m√©tadonn√©es:</strong> ${result.total_photos_with_metadata}</p>
                        <div style="margin-top: 15px; max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <h6>üìã Journal de la migration:</h6>
                            ${logDisplay}
                        </div>
                    `;
                    
                    showAlert('‚úÖ Migration termin√©e avec succ√®s ! Vous pouvez maintenant utiliser les fonctionnalit√©s d\'optimisation.', 'success');
                    
                    // Recharger les statistiques
                    setTimeout(() => {
                        loadOptimizationStats();
                    }, 2000);
                } else {
                    const error = await response.json();
                    showAlert(`‚ùå Erreur de migration: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('‚ùå Erreur de connexion lors de la migration', 'error');
            }
        }

        async function reloadModels() {
            if (!confirm('üîÑ Recharger les mod√®les SQLAlchemy ? Cela peut r√©soudre les erreurs apr√®s migration.')) {
                return;
            }

            try {
                showAlert('üîÑ Rechargement des mod√®les en cours...', 'info');
                
                const response = await fetch('/api/admin/reload-models', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    let logDisplay = result.log.map(line => `<p>‚Ä¢ ${line}</p>`).join('');
                    
                    document.getElementById('cleanupResult').innerHTML = `
                        <h5>${result.success ? '‚úÖ' : '‚ö†Ô∏è'} ${result.message}</h5>
                        <p><strong>Colonnes d'optimisation d√©tect√©es:</strong> ${result.optimization_columns_detected}/6</p>
                        <p><strong>Pr√™t pour statistiques:</strong> ${result.ready_for_stats ? 'Oui ‚úÖ' : 'Non ‚ùå'}</p>
                        <div style="margin-top: 15px; max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <h6>üìã Journal du rechargement:</h6>
                            ${logDisplay}
                        </div>
                    `;
                    
                    if (result.ready_for_stats) {
                        showAlert('‚úÖ Mod√®les recharg√©s ! Les statistiques devraient maintenant fonctionner.', 'success');
                        
                        // Recharger les statistiques apr√®s 2 secondes
                        setTimeout(() => {
                            loadOptimizationStats();
                        }, 2000);
                    } else {
                        showAlert(`‚ö†Ô∏è Rechargement partiellement r√©ussi. Colonnes manquantes: ${result.missing_columns?.join(', ') || 'Inconnues'}`, 'warning');
                    }
                } else {
                    const error = await response.json();
                    showAlert(`‚ùå Erreur de rechargement: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('‚ùå Erreur de connexion lors du rechargement', 'error');
            }
        }

        // Charger les statistiques automatiquement quand on ouvre l'onglet optimisation
        window.__origShowTabOptimization = window.__origShowTabOptimization || showTab;
        showTab = function(tabName) {
            window.__origShowTabOptimization(tabName);
            if (tabName === 'optimization') {
                loadOptimizationStats();
            }
        };
    </script>
</body>
</html> 